# PR #17 Bugfixes Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Fix all 13 verified bugs from the PR #17 code review.

**Architecture:** Isolated fixes grouped by file. No architectural changes. TDD where tests exist (Go backend). Frontend fixes are manual-verification only (no JS test framework).

**Tech Stack:** Go 1.24, vanilla JS, BoltDB, htmx

---

### Task 1: H1 — Make FetchToken registry-aware

**Files:**
- Modify: `internal/registry/auth.go:22-59`
- Modify: `internal/registry/checker.go:128`
- Modify: `internal/registry/tags.go:33-38`
- Test: `internal/registry/auth_test.go`

**Step 1: Write a failing test for registry-aware FetchToken**

Add to `auth_test.go`:

```go
func TestFetchTokenUsesRegistryHost(t *testing.T) {
	// Verify that FetchToken for Docker Hub hits the Docker Hub auth endpoint,
	// and that a non-Hub registry gets a different URL pattern.
	called := false
	server := httptest.NewServer(http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
		called = true
		// Non-Hub registries should hit /v2/ with basic auth for token challenge
		if r.URL.Path == "/token" {
			w.Header().Set("Content-Type", "application/json")
			_ = json.NewEncoder(w).Encode(TokenResponse{Token: "hub-token"})
			return
		}
		// /v2/ endpoint returns 200 with basic auth
		w.Header().Set("Content-Type", "application/json")
		_ = json.NewEncoder(w).Encode(TokenResponse{Token: "direct-token"})
	}))
	defer server.Close()

	// Test that the host parameter is passed through (won't actually route
	// to the test server since URLs are built from the host param, but
	// we can verify the function signature compiles and accepts the host).
	// Full integration testing requires a mock registry.
	_ = server
	_ = called
}
```

**Step 2: Run test to verify it compiles**

Run: `cd /home/lns/Docker-Sentinel && go test ./internal/registry/ -run TestFetchTokenUsesRegistryHost -v`

**Step 3: Update FetchToken to accept registryHost**

In `auth.go`, modify `FetchToken` to be registry-aware:

```go
// FetchToken retrieves a bearer token for the given registry.
// For Docker Hub (host "docker.io" or ""), it uses auth.docker.io.
// For other registries, credentials are used directly as Basic auth
// by the caller — this function only handles Docker Hub token exchange.
func FetchToken(ctx context.Context, repo string, cred *RegistryCredential, host string) (string, error) {
	// Only Docker Hub uses the token exchange flow.
	// Other registries use Basic auth directly on v2 API calls.
	if host != "" && host != "docker.io" {
		return "", nil // no token needed; caller uses Basic auth directly
	}

	url := "https://auth.docker.io/token?service=registry.docker.io&scope=repository:" + repo + ":pull"

	req, err := http.NewRequestWithContext(ctx, http.MethodGet, url, nil)
	if err != nil {
		return "", fmt.Errorf("create auth request: %w", err)
	}

	if cred != nil {
		req.SetBasicAuth(cred.Username, cred.Secret)
	}

	resp, err := httpClient.Do(req)
	if err != nil {
		return "", fmt.Errorf("fetch token: %w", err)
	}
	defer resp.Body.Close()

	if resp.StatusCode != http.StatusOK {
		return "", fmt.Errorf("auth endpoint returned %d", resp.StatusCode)
	}

	var tok TokenResponse
	if err := json.NewDecoder(resp.Body).Decode(&tok); err != nil {
		return "", fmt.Errorf("decode token response: %w", err)
	}
	if tok.Token == "" {
		return "", fmt.Errorf("empty token in response")
	}

	return tok.Token, nil
}
```

Update `FetchAnonymousToken`:
```go
func FetchAnonymousToken(ctx context.Context, repo string) (string, error) {
	return FetchToken(ctx, repo, nil, "docker.io")
}
```

Update caller in `checker.go:128`:
```go
	token, err := FetchToken(ctx, repo, cred, host)
```

Update `ListTags` in `tags.go` to accept and use Basic auth for non-Hub registries. Add `host` and `cred` parameters:
```go
func ListTags(ctx context.Context, imageRef string, token string, host string, cred *RegistryCredential) (TagsResult, error) {
	repo := NormaliseRepo(imageRef)
	var url string
	if host != "" && host != "docker.io" {
		url = "https://" + host + "/v2/" + repo + "/tags/list"
	} else {
		url = "https://registry-1.docker.io/v2/" + repo + "/tags/list"
	}

	req, err := http.NewRequestWithContext(ctx, http.MethodGet, url, nil)
	if err != nil {
		return TagsResult{}, fmt.Errorf("create tags request: %w", err)
	}
	if token != "" {
		req.Header.Set("Authorization", "Bearer "+token)
	} else if cred != nil {
		// Non-Hub registries: use Basic auth directly
		req.SetBasicAuth(cred.Username, cred.Secret)
	}

	// ... rest unchanged
```

Update caller in `checker.go:134`:
```go
	tagsResult, err := ListTags(ctx, imageRef, token, host, cred)
```

**Step 4: Run all registry tests**

Run: `cd /home/lns/Docker-Sentinel && go test ./internal/registry/ -v`
Expected: all pass

**Step 5: Commit**

```bash
cd /home/lns/Docker-Sentinel && git add internal/registry/auth.go internal/registry/auth_test.go internal/registry/checker.go internal/registry/tags.go && git commit -m "fix(H1): make FetchToken and ListTags registry-aware"
```

---

### Task 2: H2 — Fix Firefox saveRegistryCredentials event parameter

**Files:**
- Modify: `internal/web/static/app.js:3198`
- Modify: `internal/web/static/settings.html:352`

**Step 1: Fix the JS function signature**

In `app.js:3198`, change:
```js
function saveRegistryCredentials() {
    collectRegistryCredentialsFromDOM();
    var btn = event.target;
```
to:
```js
function saveRegistryCredentials(event) {
    collectRegistryCredentialsFromDOM();
    var btn = event && event.target ? event.target.closest(".btn") : null;
```

Also guard the loading class usage:
```js
    if (btn) btn.classList.add("loading");
```
and in the `.then` and `.catch`:
```js
    if (btn) btn.classList.remove("loading");
```

**Step 2: Fix the HTML onclick**

In `settings.html:352`, change:
```html
<button class="btn btn-success" onclick="saveRegistryCredentials()">Save All</button>
```
to:
```html
<button class="btn btn-success" onclick="saveRegistryCredentials(event)">Save All</button>
```

**Step 3: Commit**

```bash
cd /home/lns/Docker-Sentinel && git add internal/web/static/app.js internal/web/static/settings.html && git commit -m "fix(H2): pass event parameter to saveRegistryCredentials for Firefox"
```

---

### Task 3: H3 — Fix test credential lookup by ID

**Files:**
- Modify: `internal/web/api.go:1778-1801`

**Step 1: Add ID field to test request and fix lookup**

In `api.go`, change the test handler struct (line 1778-1782):
```go
	var body struct {
		ID       string `json:"id"`
		Registry string `json:"registry"`
		Username string `json:"username"`
		Secret   string `json:"secret"`
	}
```

Change the masked secret restoration logic (line 1792-1801):
```go
	// If secret is masked, try to restore from saved credentials.
	if strings.HasSuffix(body.Secret, "****") && s.deps.RegistryCredentials != nil {
		existing, _ := s.deps.RegistryCredentials.GetRegistryCredentials()
		restored := false
		// Prefer lookup by ID (stable even if registry field was edited).
		if body.ID != "" {
			for _, c := range existing {
				if c.ID == body.ID {
					body.Secret = c.Secret
					restored = true
					break
				}
			}
		}
		// Fall back to registry name lookup.
		if !restored {
			for _, c := range existing {
				if c.Registry == body.Registry {
					body.Secret = c.Secret
					break
				}
			}
		}
	}
```

**Step 2: Update frontend to send ID in test request**

In `app.js`, find `testRegistryCredential` and ensure it sends the `id` field:

```js
function testRegistryCredential(index) {
    collectRegistryCredentialsFromDOM();
    var cred = registryCredentials[index];
    if (!cred) return;
    // ... existing code should already send cred.id in the body
```

Check that the fetch body includes `id: cred.id`. If not, add it.

**Step 3: Commit**

```bash
cd /home/lns/Docker-Sentinel && git add internal/web/api.go internal/web/static/app.js && git commit -m "fix(H3): test credential lookup by ID instead of registry name"
```

---

### Task 4: L2→H — Re-enable bulk queue action button

**Files:**
- Modify: `internal/web/static/app.js:920-936`

**Step 1: Fix bulkQueueAction to re-enable the trigger button**

Replace the function (lines 920-936):
```js
function bulkQueueAction(actionFn, triggerBtn) {
    var rows = document.querySelectorAll(".table-wrap tbody tr.container-row");
    if (!rows.length) return;
    if (triggerBtn) {
        triggerBtn.classList.add("loading");
        triggerBtn.disabled = true;
    }
    var delay = 0;
    var total = rows.length;
    var processed = 0;
    rows.forEach(function (row) {
        var link = row.querySelector(".container-link");
        var name = link ? link.textContent.trim() : null;
        if (!name) { total--; return; }
        var btn = row.querySelector(".btn");
        setTimeout(function () {
            actionFn(name, { target: btn });
            processed++;
            if (processed >= total && triggerBtn) {
                triggerBtn.classList.remove("loading");
                triggerBtn.disabled = false;
            }
        }, delay);
        delay += 150;
    });
    // Handle edge case: no valid rows
    if (total <= 0 && triggerBtn) {
        triggerBtn.classList.remove("loading");
        triggerBtn.disabled = false;
    }
}
```

**Step 2: Commit**

```bash
cd /home/lns/Docker-Sentinel && git add internal/web/static/app.js && git commit -m "fix(L2): re-enable bulk action button after all rows processed"
```

---

### Task 5: M2 — Add input validation on credential save

**Files:**
- Modify: `internal/web/api.go:1692-1731`

**Step 1: Add validation before save**

Insert validation after line 1703 (after JSON decode, before restore):
```go
	// Validate credentials.
	seen := make(map[string]bool, len(creds))
	for _, c := range creds {
		if strings.TrimSpace(c.Registry) == "" {
			writeError(w, http.StatusBadRequest, "registry cannot be empty")
			return
		}
		if strings.TrimSpace(c.Username) == "" {
			writeError(w, http.StatusBadRequest, "username cannot be empty for "+c.Registry)
			return
		}
		if strings.TrimSpace(c.Secret) == "" {
			writeError(w, http.StatusBadRequest, "secret cannot be empty for "+c.Registry)
			return
		}
		norm := NormaliseRegistryHost(c.Registry)
		if seen[norm] {
			writeError(w, http.StatusBadRequest, "duplicate registry: "+c.Registry)
			return
		}
		seen[norm] = true
	}
```

Note: import `registry.NormaliseRegistryHost` — or since this is in the web package, use the web-level type alias. Check how `NormaliseRegistryHost` is exposed. If not accessible, inline the normalisation or add a helper.

**Step 2: Run build**

Run: `cd /home/lns/Docker-Sentinel && go build ./...`
Expected: compiles

**Step 3: Commit**

```bash
cd /home/lns/Docker-Sentinel && git add internal/web/api.go && git commit -m "fix(M2): validate registry credentials before save"
```

---

### Task 6: M3 — Add request counting to CanProceed

**Files:**
- Modify: `internal/registry/ratelimit.go:12-19,126-148`
- Test: `internal/registry/ratelimit_test.go`

**Step 1: Write failing test**

Add to `ratelimit_test.go`:
```go
func TestCanProceedDecrementsRemaining(t *testing.T) {
	tracker := NewRateLimitTracker()

	h := make(http.Header)
	h.Set("RateLimit-Limit", "100;w=21600")
	h.Set("RateLimit-Remaining", "12;w=21600")
	tracker.Record("docker.io", h)

	// First call with reserve=10: 12 > 10, should proceed
	ok, _ := tracker.CanProceed("docker.io", 10)
	if !ok {
		t.Fatal("first CanProceed should succeed (12 > 10)")
	}
	// Second call: effective remaining is 11, still > 10
	ok, _ = tracker.CanProceed("docker.io", 10)
	if !ok {
		t.Fatal("second CanProceed should succeed (11 > 10)")
	}
	// Third call: effective remaining is 10, not > 10 — blocked
	ok, _ = tracker.CanProceed("docker.io", 10)
	if ok {
		t.Fatal("third CanProceed should fail (10 <= 10)")
	}
}

func TestRecordResetsRequestCount(t *testing.T) {
	tracker := NewRateLimitTracker()

	h := make(http.Header)
	h.Set("RateLimit-Limit", "100;w=21600")
	h.Set("RateLimit-Remaining", "12;w=21600")
	tracker.Record("docker.io", h)

	// Use up some quota
	tracker.CanProceed("docker.io", 10) // effective 11
	tracker.CanProceed("docker.io", 10) // effective 10 — blocked

	// Fresh Record should reset the counter
	h2 := make(http.Header)
	h2.Set("RateLimit-Limit", "100;w=21600")
	h2.Set("RateLimit-Remaining", "50;w=21600")
	tracker.Record("docker.io", h2)

	ok, _ := tracker.CanProceed("docker.io", 10)
	if !ok {
		t.Fatal("after Record, CanProceed should succeed again (50 > 10)")
	}
}
```

**Step 2: Run test to verify it fails**

Run: `cd /home/lns/Docker-Sentinel && go test ./internal/registry/ -run TestCanProceedDecrementsRemaining -v`
Expected: FAIL — third call still returns true

**Step 3: Add requestCount field and update CanProceed + Record**

In `ratelimit.go`, add field to `RegistryState`:
```go
type RegistryState struct {
	Limit          int       `json:"limit"`
	Remaining      int       `json:"remaining"`
	ResetAt        time.Time `json:"reset_at"`
	IsAuth         bool      `json:"is_auth"`
	HasLimits      bool      `json:"has_limits"`
	ContainerCount int       `json:"container_count"`
	LastUpdated    time.Time `json:"last_updated"`
	requestCount   int       // requests made since last Record(); not serialised
}
```

In `Record()`, after updating `s.Remaining`, add:
```go
	s.requestCount = 0
```
(Add this reset line before each `return` in Record that sets rate limit data.)

In `CanProceed()`, change the check (line 138) and add increment:
```go
	if s.Remaining-s.requestCount > reserve {
		s.requestCount++
		return true, 0
	}
```

Note: `CanProceed` currently takes `RLock`. Since it now mutates `requestCount`, change to `Lock/Unlock`:
```go
func (t *RateLimitTracker) CanProceed(registry string, reserve int) (bool, time.Duration) {
	t.mu.Lock()
	defer t.mu.Unlock()
```

**Step 4: Run tests**

Run: `cd /home/lns/Docker-Sentinel && go test ./internal/registry/ -v`
Expected: all pass including new tests

**Step 5: Commit**

```bash
cd /home/lns/Docker-Sentinel && git add internal/registry/ratelimit.go internal/registry/ratelimit_test.go && git commit -m "fix(M3): track request count in CanProceed to prevent overshoot"
```

---

### Task 7: L1 — Restrict drag to handle only

**Files:**
- Modify: `internal/web/static/app.js:1615-1626`

**Step 1: Fix the dragstart handler**

Replace lines 1615-1626:
```js
    document.addEventListener("dragstart", function (e) {
        var group = e.target.closest(".stack-group");
        if (!group || !manageMode) return;
        // Only allow drag from the handle element.
        if (!e.target.closest(".stack-drag-handle")) {
            e.preventDefault();
            return;
        }
        dragSrc = group;
        group.classList.add("dragging");
        e.dataTransfer.effectAllowed = "move";
        e.dataTransfer.setData("text/plain", group.getAttribute("data-stack"));
    });
```

**Step 2: Commit**

```bash
cd /home/lns/Docker-Sentinel && git add internal/web/static/app.js && git commit -m "fix(L1): restrict stack drag to handle element only"
```

---

### Task 8: L3 — Replace http.DefaultClient in test credential handler

**Files:**
- Modify: `internal/web/api.go:1820`

**Step 1: Replace DefaultClient with timeout client**

Change line 1820:
```go
	resp, err := http.DefaultClient.Do(req)
```
to:
```go
	client := &http.Client{Timeout: 10 * time.Second}
	resp, err := client.Do(req)
```

**Step 2: Run build**

Run: `cd /home/lns/Docker-Sentinel && go build ./...`

**Step 3: Commit**

```bash
cd /home/lns/Docker-Sentinel && git add internal/web/api.go && git commit -m "fix(L3): use timeout client for credential test instead of DefaultClient"
```

---

### Task 9: L5 — Validate-then-save for digest settings

**Files:**
- Modify: `internal/web/api.go:1500-1555`

**Step 1: Refactor to validate all fields first, then save**

Replace the handler body (lines 1517-1546):
```go
	// Validate all fields before saving any.
	if body.Time != "" {
		if _, err := time.Parse("15:04", body.Time); err != nil {
			writeError(w, http.StatusBadRequest, "invalid time format, use HH:MM")
			return
		}
	}
	if body.Interval != "" {
		if _, err := time.ParseDuration(body.Interval); err != nil {
			writeError(w, http.StatusBadRequest, "invalid interval duration")
			return
		}
	}
	if body.DefaultNotifyMode != "" {
		switch body.DefaultNotifyMode {
		case "default", "every_scan", "digest_only", "muted":
			// valid
		default:
			writeError(w, http.StatusBadRequest, "invalid default_notify_mode")
			return
		}
	}

	// All valid — save atomically.
	if body.Enabled != nil {
		val := "true"
		if !*body.Enabled {
			val = "false"
		}
		_ = s.deps.SettingsStore.SaveSetting("digest_enabled", val)
	}
	if body.Time != "" {
		_ = s.deps.SettingsStore.SaveSetting("digest_time", body.Time)
	}
	if body.Interval != "" {
		_ = s.deps.SettingsStore.SaveSetting("digest_interval", body.Interval)
	}
	if body.DefaultNotifyMode != "" {
		_ = s.deps.SettingsStore.SaveSetting("default_notify_mode", body.DefaultNotifyMode)
	}
```

**Step 2: Run build**

Run: `cd /home/lns/Docker-Sentinel && go build ./...`

**Step 3: Commit**

```bash
cd /home/lns/Docker-Sentinel && git add internal/web/api.go && git commit -m "fix(L5): validate all digest settings before saving any"
```

---

### Task 10: M5 — Log json.Unmarshal error in stack order loading

**Files:**
- Modify: `internal/web/handlers.go:144-146`

**Step 1: Replace silenced error with log**

Change lines 144-146:
```go
	if savedJSON != "" {
		_ = json.Unmarshal([]byte(savedJSON), &savedOrder)
	}
```
to:
```go
	if savedJSON != "" {
		if err := json.Unmarshal([]byte(savedJSON), &savedOrder); err != nil {
			s.deps.Log.Warn("failed to parse saved stack order, using defaults", "error", err)
			savedOrder = nil
		}
	}
```

**Step 2: Run build**

Run: `cd /home/lns/Docker-Sentinel && go build ./...`

**Step 3: Commit**

```bash
cd /home/lns/Docker-Sentinel && git add internal/web/handlers.go && git commit -m "fix(M5): log json.Unmarshal error in stack order loading"
```

---

### Task 11: M6 — Rename "Images" to "Containers" in rate limits table

**Files:**
- Modify: `internal/web/static/app.js:2985`

**Step 1: Fix the column header**

Change line 2985:
```js
    ["Registry", "Images", "Remaining", "Resets", "Auth"].forEach(function(label) {
```
to:
```js
    ["Registry", "Containers", "Remaining", "Resets", "Auth"].forEach(function(label) {
```

**Step 2: Commit**

```bash
cd /home/lns/Docker-Sentinel && git add internal/web/static/app.js && git commit -m "fix(M6): rename rate limits 'Images' column to 'Containers'"
```

---

### Task 12: M1 + M4 — Document Docker Hub-only limitations

**Files:**
- Modify: `internal/registry/checker.go:99-101`
- Modify: `internal/registry/tags.go:33-36`

**Step 1: Add documentation comments**

In `checker.go`, update the comment above `CheckVersioned` (line 99-100):
```go
// CheckVersioned performs a digest check and, for versioned tags, also looks
// for newer semver releases by listing remote tags.
//
// Note: Version detection (semver tag listing) currently supports Docker Hub
// and registries with compatible v2 tag listing APIs. Rate limit headers are
// only captured from the tag listing response, not from digest checks
// (DistributionInspect uses the Docker daemon's internal client which does
// not expose HTTP headers).
```

In `tags.go`, update the comment above `ListTags` (line 33-34):
```go
// ListTags fetches all tags for the given image reference from a container registry.
// For Docker Hub, it uses registry-1.docker.io. For other registries, it uses
// the registry host extracted from the image reference.
// The token is a bearer token for Docker Hub; for other registries, pass empty
// token and provide credentials via the cred parameter for Basic auth.
```

**Step 2: Run build**

Run: `cd /home/lns/Docker-Sentinel && go build ./...`

**Step 3: Commit**

```bash
cd /home/lns/Docker-Sentinel && git add internal/registry/checker.go internal/registry/tags.go && git commit -m "docs(M1,M4): document rate limit tracking and registry support limitations"
```

---

### Task 13: M7 — Update design doc tabs

**Files:**
- Modify: `docs/plans/2026-02-12-qa-audit-design.md:38`

**Step 1: Update the tab list**

Change line 38:
```markdown
- Tab switching (Containers, Notifications, Authentication)
```
to:
```markdown
- Tab switching (Scanning, Notifications, Registries, Appearance, General, Security)
```

**Step 2: Commit**

```bash
cd /home/lns/Docker-Sentinel && git add docs/plans/2026-02-12-qa-audit-design.md && git commit -m "docs(M7): update QA design doc to list all 6 settings tabs"
```

---

### Task 14: Final verification

**Step 1: Run full test suite**

Run: `cd /home/lns/Docker-Sentinel && go test ./... -v`
Expected: all pass

**Step 2: Build binary**

Run: `cd /home/lns/Docker-Sentinel && go build -o /dev/null ./cmd/sentinel/`
Expected: compiles

**Step 3: Review all commits**

Run: `cd /home/lns/Docker-Sentinel && git log --oneline -15`
Verify: 13 fix commits present
