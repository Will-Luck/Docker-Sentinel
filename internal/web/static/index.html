{{define "index.html"}}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Docker-Sentinel</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png">
    <link rel="apple-touch-icon" href="/static/apple-touch-icon.png">
</head>
<body>
    <a href="#main-content" class="skip-link">Skip to main content</a>
    <nav class="nav">
        <a href="/" class="nav-brand">
            <img src="/favicon.svg" alt="S" class="nav-logo">
            <span class="nav-brand-text">Sentinel</span>
        </a>
        <div class="nav-links">
            <a href="/" class="nav-link active" aria-current="page">Dashboard</a>
            <a href="/queue" class="nav-link">
                Pending Updates
                {{if .QueueCount}}<span class="nav-badge">{{.QueueCount}}</span>{{end}}
            </a>
            <a href="/history" class="nav-link">History</a>
            <a href="/logs" class="nav-link">Logs</a>
            <a href="/settings" class="nav-link">Settings</a>
        </div>
        <div class="nav-status" aria-live="polite">
            <span id="sse-indicator" class="status-dot disconnected"></span>
            <span id="sse-label" class="nav-status-text">Disconnected</span>
        </div>
        {{if .AuthEnabled}}{{if .CurrentUser}}
        <div class="nav-user">
            <button class="nav-user-btn" onclick="toggleUserDropdown(event)" aria-haspopup="true" aria-expanded="false">
                <span>{{.CurrentUser.Username}}</span>
                <span class="nav-user-role">{{.CurrentUser.RoleID}}</span>
                <span class="nav-user-chevron">&#9662;</span>
            </button>
            <div class="nav-user-dropdown" id="user-dropdown">
                <a href="/account">My Account</a>
                <div class="dropdown-divider"></div>
                <form method="POST" action="/logout" style="margin:0">
                    <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
                    <button type="submit">Logout</button>
                </form>
            </div>
        </div>
        {{end}}{{else}}
        <div class="nav-auth-off">Auth: Off</div>
        {{end}}
    </nav>

    <main class="main-content" id="main-content">
        <div class="page-header">
            <div>
                <h1>Containers</h1>
                <p class="subtitle">Monitored containers and their update status</p>
            </div>
        </div>

        <dl class="stats" id="stats">
            <div class="stat-card stat-card-link" style="cursor:pointer" onclick="activateFilter('sort','status')">
                <dt class="stat-label"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" style="display:inline;vertical-align:-2px;margin-right:4px"><rect x="1" y="3" width="14" height="4" rx="1" fill="currentColor" opacity=".6"/><rect x="1" y="9" width="14" height="4" rx="1" fill="currentColor" opacity=".4"/></svg>Total</dt>
                <dd class="stat-value info">{{.TotalContainers}}</dd>
            </div>
            <div class="stat-card stat-card-link" style="cursor:pointer" onclick="activateFilter('status','running')">
                <dt class="stat-label"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" style="display:inline;vertical-align:-2px;margin-right:4px"><path d="M13.65 2.35A7.96 7.96 0 008 0C3.58 0 0 3.58 0 8s3.58 8 8 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 018 14 6 6 0 012 8a6 6 0 016-6c1.66 0 3.14.69 4.22 1.78L9 7h7V0l-2.35 2.35z" fill="currentColor"/></svg>Running</dt>
                <dd class="stat-value success">{{.RunningContainers}}</dd>
            </div>
            <a href="/queue" class="stat-card stat-card-link">
                <dt class="stat-label"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" style="display:inline;vertical-align:-2px;margin-right:4px"><path d="M8 1L1 14h14L8 1zm-.75 5h1.5v4h-1.5V6zm0 5h1.5v1.5h-1.5V11z" fill="currentColor"/></svg>Updates Pending</dt>
                <dd class="stat-value warning">{{.PendingUpdates}}</dd>
            </a>
            <a href="/settings" class="stat-card stat-card-link" onclick="localStorage.setItem('sentinel-settings-tab','registries')">
                <dt class="stat-label">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:inline;vertical-align:-2px;margin-right:4px"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>Rate Limits
                </dt>
                <dd class="stat-value" id="rate-limit-status">Healthy</dd>
            </a>
        </dl>

        <div id="pause-banner" class="pause-banner" style="display:none">
            <span>Scanning is paused</span>
            <button class="btn btn-warning" onclick="resumeScanning()">Resume</button>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-header-top">
                    <h2>Container Status</h2>
                    <div class="btn-group">
                        <button class="btn" onclick="expandAllStacks()">Expand All</button>
                        <button class="btn" onclick="collapseAllStacks()">Collapse All</button>
                        <button class="btn" id="manage-btn" onclick="toggleManageMode()">Manage</button>
                        <button class="btn btn-info" id="scan-btn" onclick="triggerScan(event)">Check for Updates</button>
                    </div>
                    <span class="last-scan" id="last-scan"></span>
                </div>
                <div class="filter-bar" id="filter-bar">
                    <button class="filter-pill" data-filter="status" data-value="running" data-exclusive="container-filter">Running</button>
                    <button class="filter-pill" data-filter="status" data-value="stopped" data-exclusive="container-filter">Stopped</button>
                    <span class="filter-divider"></span>
                    <button class="filter-pill" data-filter="updates" data-value="pending" data-exclusive="container-filter">Updatable</button>
                    <span class="filter-divider"></span>
                    <button class="filter-pill" data-filter="sort" data-value="alpha" data-exclusive="sort">A-Z</button>
                    <button class="filter-pill" data-filter="sort" data-value="status" data-exclusive="sort">Status</button>
                </div>
            </div>
            <div class="table-wrap">
                <table id="container-table">
                    <colgroup>
                        <col style="width:40px">
                        <col style="width:25%">
                        <col>
                        <col style="width:120px">
                        <col style="width:100px">
                        <col style="width:140px">
                    </colgroup>
                    <thead>
                        <tr>
                            <th class="th-checkbox"><input type="checkbox" id="select-all" title="Select all"><label for="select-all" class="sr-only">Select all containers</label></th>
                            <th>Name</th>
                            <th>Image</th>
                            <th class="policy-header">
                                Policy
                                <span class="policy-help" tabindex="0" role="button" aria-label="Policy information">
                                    <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor" style="vertical-align:-2px"><circle cx="8" cy="8" r="7" fill="none" stroke="currentColor" stroke-width="1.5"/><text x="8" y="12" text-anchor="middle" font-size="11" font-weight="700" font-family="system-ui">i</text></svg>
                                    <span class="policy-tooltip" id="policy-tooltip-info">
                                        <strong>auto</strong> — updates applied automatically<br>
                                        <strong>manual</strong> — queued for approval<br>
                                        <strong>pinned</strong> — never updated
                                    </span>
                                </span>
                            </th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    {{if .Stacks}}
                        {{range .Stacks}}
                        <tbody class="stack-group stack-collapsed{{if gt .StoppedCount 0}} stack-has-stopped{{else if .HasPending}} stack-has-pending{{else}} stack-healthy{{end}}" data-stack="{{.Name}}">
                            <tr class="stack-header{{if .HasPending}} stack-pending{{end}}" onclick="toggleStack(this)">
                                <td colspan="6">
                                    <div class="stack-header-inner">
                                        <span class="stack-drag-handle" title="Drag to reorder">&#10495;</span>
                                        <input type="checkbox" class="stack-select" data-stack="{{.Name}}" title="Select all in {{.Name}}" onclick="event.stopPropagation()">
                                        <span class="stack-chevron">&#9656;</span>
                                        <span class="stack-name">{{.Name}}</span>
                                        <span class="stack-counts">
                                            <span class="stack-indicator stack-indicator-running">{{.RunningCount}}</span>
                                            {{if .StoppedCount}}<span class="stack-indicator stack-indicator-stopped">{{.StoppedCount}}</span>{{end}}
                                            {{if .PendingCount}}<span class="stack-indicator stack-indicator-pending">{{.PendingCount}}</span>{{end}}
                                        </span>
                                    </div>
                                </td>
                            </tr>
                            {{range .Containers}}
                            {{template "container-row" .}}
                            {{end}}
                        </tbody>
                        {{end}}
                    {{else}}
                        <tbody>
                            <tr>
                                <td colspan="6">
                                    <div class="empty-state">
                                        <h3>No containers found</h3>
                                        <p>Sentinel is not monitoring any containers yet.</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    {{end}}

                    {{if .SwarmServices}}
                    <tbody class="section-separator">
                        <tr><td colspan="6"><div class="section-divider">
                            <span class="section-title">Swarm Services</span>
                            <span class="section-summary">{{len .SwarmServices}} services</span>
                        </div></td></tr>
                    </tbody>

                    {{range .SwarmServices}}
                    <tbody class="svc-group svc-collapsed" data-service="{{.Name}}">
                        <tr class="svc-header{{if .HasUpdate}} has-update{{end}}" data-registry="{{.Registry}}" onclick="toggleSvc(this)">
                            <td class="td-checkbox">
                                <input type="checkbox" class="row-select" value="{{.Name}}" id="select-svc-{{.Name}}" aria-label="Select {{.Name}}">
                            </td>
                            <td>
                                <span class="stack-chevron">&#9656;</span>
                                <a href="/service/{{.Name}}" class="svc-name" onclick="event.stopPropagation()">{{.Name}}</a>
                            </td>
                            <td class="cell-image mono" title="{{.Image}}">
                                {{$tag := .Tag}}{{$img := .Image}}{{$ver := .NewestVersion}}
                                {{if .NewestVersion}}
                                    <span class="version-current">{{$tag}}</span>
                                    <span class="version-arrow">&rarr;</span>
                                    {{with versionURL $img $ver}}
                                        <a href="{{.}}" target="_blank" rel="noopener" class="version-new version-link">{{$ver}}</a>
                                    {{else}}
                                        <span class="version-new">{{$ver}}</span>
                                    {{end}}
                                {{else}}
                                    {{with changelogURL $img}}
                                        <a href="{{.}}" target="_blank" rel="noopener" class="version-link">{{$tag}}</a>
                                    {{else}}
                                        {{$tag}}
                                    {{end}}
                                {{end}}
                            </td>
                            <td>
                                <select class="policy-select policy-{{.Policy}}"
                                        onchange="this.className='policy-select policy-'+this.value; changeSvcPolicy('{{.Name}}', this.value)"
                                        data-current="{{.Policy}}">
                                    <option value="auto"{{if eq .Policy "auto"}} selected{{end}}>auto</option>
                                    <option value="manual"{{if eq .Policy "manual"}} selected{{end}}>manual</option>
                                    <option value="pinned"{{if eq .Policy "pinned"}} selected{{end}}>pinned</option>
                                </select>
                            </td>
                            <td>
                                {{if gt .DesiredReplicas 0}}
                                <span class="status-badge-wrap" data-service="{{.Name}}" data-prev-replicas="{{.DesiredReplicas}}">
                                    <span class="badge svc-replicas {{if eq .RunningReplicas .DesiredReplicas}}svc-replicas-healthy{{else if gt .RunningReplicas 0}}svc-replicas-degraded{{else}}svc-replicas-down{{end}} badge-default">{{.Replicas}}</span>
                                    <span class="badge badge-error badge-hover" onclick="event.stopPropagation(); scaleSvc('{{.Name}}', 0, this.closest('.status-badge-wrap'))">Scale to 0</span>
                                </span>
                                {{else}}
                                <span class="status-badge-wrap" data-service="{{.Name}}" data-prev-replicas="{{if gt .PrevReplicas 0}}{{.PrevReplicas}}{{else}}{{.DesiredReplicas}}{{end}}">
                                    <span class="badge svc-replicas svc-replicas-down badge-default">{{.Replicas}}</span>
                                    <span class="badge badge-success badge-hover" onclick="event.stopPropagation(); scaleSvc('{{.Name}}', {{if gt .PrevReplicas 0}}{{.PrevReplicas}}{{else if gt .DesiredReplicas 0}}{{.DesiredReplicas}}{{else}}1{{end}}, this.closest('.status-badge-wrap'))">Scale up</span>
                                </span>
                                {{end}}
                            </td>
                            <td>
                                <div class="btn-group">
                                {{if and .HasUpdate (ne .Policy "pinned")}}
                                    <button class="btn btn-warning btn-sm"
                                            onclick="event.stopPropagation(); triggerSvcUpdate('{{.Name}}', event)">
                                        Update
                                    </button>
                                {{end}}
                                {{if eq .UpdateStatus "completed"}}
                                    <button class="btn btn-sm"
                                            onclick="event.stopPropagation(); rollbackSvc('{{.Name}}', event)">
                                        Rollback
                                    </button>
                                {{end}}
                                    <a href="/service/{{.Name}}" class="btn btn-sm" onclick="event.stopPropagation()">Full Details</a>
                                </div>
                            </td>
                        </tr>

                        {{if .Tasks}}
                        {{range .Tasks}}
                        <tr class="svc-task-row">
                            <td></td>
                            <td class="svc-node">{{.NodeName}}{{if .NodeAddr}} <span class="svc-node-addr">({{.NodeAddr}})</span>{{end}}</td>
                            <td class="mono">{{.Tag}}</td>
                            <td></td>
                            <td>
                                {{if eq .State "running"}}
                                    <span class="badge badge-success">running</span>
                                {{else if eq .State "preparing"}}
                                    <span class="badge badge-info">preparing</span>
                                {{else}}
                                    <span class="badge badge-error" title="{{.Error}}">{{.State}}</span>
                                {{end}}
                            </td>
                            <td></td>
                        </tr>
                        {{end}}
                        {{else if eq .DesiredReplicas 0}}
                        <tr class="svc-task-row">
                            <td></td>
                            <td colspan="4" class="text-muted" style="padding:var(--sp-3)">Service scaled to 0 &mdash; no active tasks</td>
                            <td></td>
                        </tr>
                        {{end}}
                    </tbody>
                    {{end}}
                    {{end}}

                </table>
            </div>
        </div>
    </main>

    <!-- Bulk action bar -->
    <div id="bulk-bar" class="bulk-bar" style="display:none">
        <span id="bulk-count" class="bulk-count">0 selected</span>
        <select id="bulk-policy" class="policy-select">
            <option value="auto">auto</option>
            <option value="manual">manual</option>
            <option value="pinned">pinned</option>
        </select>
        <button class="btn btn-success" onclick="applyBulkPolicy()">Apply Policy</button>
        <button class="btn" onclick="clearSelection()">Cancel</button>
    </div>

    <footer class="app-footer" id="app-footer">
        <span class="footer-version" id="footer-version"></span>
        <span class="footer-beta">
            This is BETA software.
            <a href="https://github.com/Will-Luck/Docker-Sentinel/issues" target="_blank" rel="noopener">Report issues on GitHub</a>
        </span>
    </footer>

    <div id="toast-container" class="toast-container"></div>
    <script src="/static/app.js"></script>
    <script src="/static/auth.js"></script>
</body>
</html>
{{end}}

{{define "container-row"}}
                            <tr class="container-row state-{{.State}}{{if .HasUpdate}} has-update{{end}}" data-name="{{.Name}}" data-registry="{{.Registry}}" onclick="onRowClick(event, '{{.Name}}')">
                                <td class="td-checkbox">
                                    {{if not .IsSelf}}
                                        <input type="checkbox" class="row-select" value="{{.Name}}" id="select-{{.Name}}" aria-label="Select {{.Name}}">
                                    {{end}}
                                </td>
                                <td>
                                    <a href="/container/{{.Name}}" class="container-link">{{.Name}}</a>
                                    {{if .IsSelf}}<span class="badge badge-muted" style="margin-left:6px;font-size:0.6rem">self</span>{{end}}
                                </td>
                                <td class="cell-image mono" title="{{.Image}}">
                                    {{$tag := .Tag}}{{$img := .Image}}{{$ver := .NewestVersion}}
                                    {{if .NewestVersion}}
                                        <span class="version-current">{{$tag}}</span>
                                        <span class="version-arrow">&rarr;</span>
                                        {{with versionURL $img $ver}}
                                            <a href="{{.}}" target="_blank" rel="noopener" class="version-new version-link">{{$ver}}</a>
                                        {{else}}
                                            <span class="version-new">{{$ver}}</span>
                                        {{end}}
                                    {{else}}
                                        {{with changelogURL $img}}
                                            <a href="{{.}}" target="_blank" rel="noopener" class="version-link">{{$tag}}</a>
                                        {{else}}
                                            {{$tag}}
                                        {{end}}
                                    {{end}}
                                </td>
                                <td>
                                    {{if .IsSelf}}
                                        <span class="policy-badge-self" title="Self-protected">
                                            <svg width="10" height="10" viewBox="0 0 16 16" fill="currentColor" style="vertical-align:-1px;margin-right:2px"><path d="M8 1a4 4 0 00-4 4v3H3a1 1 0 00-1 1v5a1 1 0 001 1h10a1 1 0 001-1V9a1 1 0 00-1-1h-1V5a4 4 0 00-4-4zm-2 4a2 2 0 114 0v3H6V5z"/></svg>
                                            self
                                        </span>
                                    {{else}}
                                        <select class="policy-select policy-{{.Policy}}"
                                                onchange="this.className='policy-select policy-'+this.value; changePolicy('{{.Name}}', this.value)"
                                                data-current="{{.Policy}}">
                                            <option value="auto" {{if eq .Policy "auto"}}selected{{end}}>auto</option>
                                            <option value="manual" {{if eq .Policy "manual"}}selected{{end}}>manual</option>
                                            <option value="pinned" {{if eq .Policy "pinned"}}selected{{end}}>pinned</option>
                                        </select>
                                    {{end}}
                                </td>
                                <td>
                                    {{if .Maintenance}}
                                        <span class="badge badge-warning">Updating</span>
                                    {{else if .HasUpdate}}
                                        <span class="badge badge-warning">Update Available</span>
                                    {{else if eq .State "running"}}
                                        {{if .IsSelf}}
                                            <span class="badge badge-success">Running</span>
                                        {{else}}
                                            <span class="status-badge-wrap" data-name="{{.Name}}" data-action="stop">
                                                <span class="badge badge-success badge-default">Running</span>
                                                <span class="badge badge-error badge-hover">Stop</span>
                                            </span>
                                        {{end}}
                                    {{else}}
                                        <span class="status-badge-wrap" data-name="{{.Name}}" data-action="start">
                                            <span class="badge badge-error badge-default">{{.State}}</span>
                                            <span class="badge badge-success badge-hover">Start</span>
                                        </span>
                                    {{end}}
                                </td>
                                <td>
                                    <div class="btn-group">
                                        {{if .IsSelf}}
                                            {{if .HasUpdate}}
                                            <button class="btn btn-info"
                                                    onclick="triggerSelfUpdate(event)">
                                                Update Sentinel
                                            </button>
                                            {{else}}
                                            <a href="/container/{{.Name}}" class="btn" onclick="event.stopPropagation()">Full Details</a>
                                            {{end}}
                                        {{else if and .HasUpdate (ne .Policy "pinned")}}
                                        <button class="btn btn-warning"
                                                onclick="triggerUpdate('{{.Name}}', event)">
                                            Update
                                        </button>
                                        {{else}}
                                        <a href="/container/{{.Name}}" class="btn" onclick="event.stopPropagation()">Full Details</a>
                                        {{end}}
                                    </div>
                                </td>
                            </tr>
{{end}}
