{{define "settings.html"}}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings — Docker-Sentinel</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png">
    <link rel="apple-touch-icon" href="/static/apple-touch-icon.png">
</head>
<body>
    <a href="#main-content" class="skip-link">Skip to main content</a>
    <nav class="nav">
        <a href="/" class="nav-brand">
            <img src="/favicon.svg" alt="S" class="nav-logo">
            <span class="nav-brand-text">Sentinel</span>
        </a>
        <div class="nav-links">
            <a href="/" class="nav-link">Dashboard</a>
            <a href="/queue" class="nav-link">
                Pending Updates
                {{if .QueueCount}}<span class="nav-badge">{{.QueueCount}}</span>{{end}}
            </a>
            <a href="/history" class="nav-link">History</a>
            <a href="/logs" class="nav-link">Logs</a>
            <a href="/settings" class="nav-link active" aria-current="page">Settings</a>
            {{if .ClusterEnabled}}<a href="/cluster" class="nav-link{{if eq .Page "cluster"}} active{{end}}">Cluster</a>{{end}}
        </div>
        <div class="nav-status" aria-live="polite">
            <span id="sse-indicator" class="status-dot disconnected"></span>
            <span id="sse-label" class="nav-status-text">Disconnected</span>
        </div>
        {{if .AuthEnabled}}{{if .CurrentUser}}
        <div class="nav-user">
            <button class="nav-user-btn" onclick="toggleUserDropdown(event)" aria-haspopup="true" aria-expanded="false">
                <span>{{.CurrentUser.Username}}</span>
                <span class="nav-user-role">{{.CurrentUser.RoleID}}</span>
                <span class="nav-user-chevron">&#9662;</span>
            </button>
            <div class="nav-user-dropdown" id="user-dropdown">
                <a href="/account">My Account</a>
                <div class="dropdown-divider"></div>
                <form method="POST" action="/logout" style="margin:0">
                    <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
                    <button type="submit">Logout</button>
                </form>
            </div>
        </div>
        {{end}}{{else}}
        <div class="nav-auth-off">Auth: Off</div>
        {{end}}
    </nav>

    <main class="main-content" id="main-content">
        <div class="page-header">
            <div>
                <h1>Settings</h1>
                <p class="subtitle">Configure Sentinel behaviour and notifications</p>
            </div>
        </div>

        <div class="tab-nav" role="tablist">
            <button class="tab-btn active" role="tab" aria-selected="true" aria-controls="tab-scanning" data-tab="scanning">Scanning</button>
            <button class="tab-btn" role="tab" aria-selected="false" aria-controls="tab-notifications" data-tab="notifications">Notifications</button>
            <button class="tab-btn" role="tab" aria-selected="false" aria-controls="tab-registries" data-tab="registries">Registries</button>
            <button class="tab-btn" role="tab" aria-selected="false" aria-controls="tab-appearance" data-tab="appearance">Appearance</button>
            <button class="tab-btn" role="tab" aria-selected="false" aria-controls="tab-general" data-tab="general">General</button>
            <button class="tab-btn" role="tab" aria-selected="false" aria-controls="tab-cluster" data-tab="cluster">Cluster</button>
            <button class="tab-btn" role="tab" aria-selected="false" aria-controls="tab-about" data-tab="about">About</button>
            {{if .AuthEnabled}}{{if .CurrentUser}}{{if eq .CurrentUser.RoleID "admin"}}
            <button class="tab-btn" role="tab" aria-selected="false" aria-controls="tab-security" data-tab="security">Security</button>
            {{end}}{{end}}{{end}}
        </div>

        <!-- Scanning tab -->
        <div class="tab-panel active" id="tab-scanning" role="tabpanel">
            <div class="card">
                <div class="card-header">
                    <h2>Scanning &amp; Behaviour</h2>
                </div>
                <div class="card-body" style="padding: var(--sp-4) var(--sp-5)">
                    <div class="settings-rows">
                        <div class="setting-row">
                            <div class="setting-info">
                                <div class="setting-label">Poll interval</div>
                                <div class="setting-desc">How often Sentinel checks for container updates</div>
                            </div>
                            <div class="poll-interval-control">
                                <select id="poll-interval" class="setting-select" onchange="onPollIntervalChange(this.value)">
                                    <option value="15m">15 minutes</option>
                                    <option value="30m">30 minutes</option>
                                    <option value="1h">1 hour</option>
                                    <option value="6h">6 hours</option>
                                    <option value="12h">12 hours</option>
                                    <option value="24h">24 hours</option>
                                    <option value="custom">Custom...</option>
                                </select>
                                <div id="poll-custom-wrap" class="custom-duration-wrap" style="display:none">
                                    <select id="poll-custom-unit" class="setting-select custom-duration-unit" onchange="onCustomUnitChange('poll')">
                                        <option value="">Unit...</option>
                                        <option value="s">Seconds</option>
                                        <option value="m">Minutes</option>
                                        <option value="h">Hours</option>
                                    </select>
                                    <input id="poll-custom-value" type="number" class="setting-select custom-duration-value" min="1" placeholder="Value" disabled>
                                    <button id="poll-custom-btn" class="btn btn-success" onclick="applyCustomPollInterval()" disabled>Apply</button>
                                </div>
                            </div>
                        </div>
                        <div class="setting-row">
                            <div class="setting-info">
                                <div class="setting-label">Default policy</div>
                                <div class="setting-desc">Policy assigned to containers without a sentinel.policy label</div>
                            </div>
                            <select id="default-policy" class="setting-select" onchange="setDefaultPolicy(this.value)">
                                <option value="auto">auto</option>
                                <option value="manual">manual</option>
                                <option value="pinned">pinned</option>
                            </select>
                        </div>
                        <div class="setting-row">
                            <div class="setting-info">
                                <div class="setting-label">On Rollback</div>
                                <div class="setting-desc">Automatically change update policy when a service or container rolls back, preventing the same broken update from being retried</div>
                            </div>
                            <select id="rollback-policy" class="setting-select" onchange="setRollbackPolicy(this.value)">
                                <option value="">No change</option>
                                <option value="manual">Set to Manual</option>
                                <option value="pinned">Set to Pinned</option>
                            </select>
                        </div>
                        <div class="setting-row">
                            <div class="setting-info">
                                <div class="setting-label">Auto-update :latest containers</div>
                                <div class="setting-desc">Containers using the :latest tag are set to auto-update, regardless of the default policy above</div>
                            </div>
                            <label class="toggle-switch-label">
                                <input type="checkbox" id="latest-auto-toggle" class="channel-toggle" onchange="setLatestAutoUpdate(this.checked)">
                                <span id="latest-auto-text" class="toggle-switch-text">On</span>
                            </label>
                        </div>
                        <div class="setting-row">
                            <div class="setting-info">
                                <div class="setting-label">Grace period</div>
                                <div class="setting-desc">Time to wait after an update before checking container health</div>
                            </div>
                            <div class="poll-interval-control">
                                <select id="grace-period" class="setting-select" onchange="onGracePeriodChange(this.value)">
                                    <option value="10s">10 seconds</option>
                                    <option value="15s">15 seconds</option>
                                    <option value="30s">30 seconds</option>
                                    <option value="1m0s">60 seconds</option>
                                    <option value="2m0s">120 seconds</option>
                                    <option value="custom">Custom...</option>
                                </select>
                                <div id="grace-custom-wrap" class="custom-duration-wrap" style="display:none">
                                    <select id="grace-custom-unit" class="setting-select custom-duration-unit" onchange="onCustomUnitChange('grace')">
                                        <option value="">Unit...</option>
                                        <option value="s">Seconds</option>
                                        <option value="m">Minutes</option>
                                        <option value="h">Hours</option>
                                    </select>
                                    <input id="grace-custom-value" type="number" class="setting-select custom-duration-value" min="1" placeholder="Value" disabled>
                                    <button id="grace-custom-btn" class="btn btn-success" onclick="applyCustomGracePeriod()" disabled>Apply</button>
                                </div>
                            </div>
                        </div>
                        <div class="setting-row">
                            <div class="setting-info">
                                <div class="setting-label">Pause scanning</div>
                                <div class="setting-desc">Temporarily stop all automatic update checks</div>
                            </div>
                            <label class="toggle-switch-label">
                                <input type="checkbox" id="pause-toggle" class="channel-toggle" onchange="setPauseState(this.checked)">
                                <span id="pause-toggle-text" class="toggle-switch-text">Off</span>
                            </label>
                        </div>
                        <div class="setting-row setting-row-top">
                            <div class="setting-info">
                                <div class="setting-label">Container filters</div>
                                <div class="setting-desc">Exclude containers matching these patterns (one per line)</div>
                            </div>
                            <div class="setting-control-stack">
                                <textarea id="container-filters" class="setting-textarea" placeholder="e.g. watchtower&#10;test-*"></textarea>
                                <button class="btn btn-success" onclick="saveFilters()">Save Filters</button>
                            </div>
                        </div>
                        <div class="setting-row">
                            <div class="setting-info">
                                <div class="setting-label">Image cleanup</div>
                                <div class="setting-desc">Automatically remove old images after a successful update</div>
                            </div>
                            <label class="toggle-switch-label">
                                <input type="checkbox" id="image-cleanup-toggle" class="channel-toggle" onchange="setImageCleanup(this.checked)">
                                <span id="image-cleanup-text" class="toggle-switch-text">On</span>
                            </label>
                        </div>
                        <div class="setting-row">
                            <div class="setting-info">
                                <div class="setting-label">Cron schedule</div>
                                <div class="setting-desc">Use a cron expression instead of the poll interval (leave empty to use poll interval)</div>
                            </div>
                            <div class="poll-interval-control">
                                <input type="text" id="cron-schedule" class="setting-select" placeholder="e.g. 0 3 * * *" style="max-width:220px">
                                <button class="btn btn-success" onclick="saveCronSchedule()">Apply</button>
                            </div>
                        </div>
                        <div class="setting-row">
                            <div class="setting-info">
                                <div class="setting-label">Dependency-aware updates</div>
                                <div class="setting-desc">Restart containers that depend on an updated container (via labels or network mode)</div>
                            </div>
                            <label class="toggle-switch-label">
                                <input type="checkbox" id="dep-aware-toggle" class="channel-toggle" onchange="setDependencyAware(this.checked)">
                                <span id="dep-aware-text" class="toggle-switch-text">On</span>
                            </label>
                        </div>
                        <div class="setting-row">
                            <div class="setting-info">
                                <div class="setting-label">Lifecycle hooks</div>
                                <div class="setting-desc">Run pre-update and post-update commands inside containers during updates</div>
                            </div>
                            <label class="toggle-switch-label">
                                <input type="checkbox" id="hooks-toggle" class="channel-toggle" onchange="setHooksEnabled(this.checked)">
                                <span id="hooks-toggle-text" class="toggle-switch-text">Off</span>
                            </label>
                        </div>
                        <div class="setting-row">
                            <div class="setting-info">
                                <div class="setting-label">Write hook labels</div>
                                <div class="setting-desc">Persist hook configurations as container labels for portability</div>
                            </div>
                            <label class="toggle-switch-label">
                                <input type="checkbox" id="hooks-labels-toggle" class="channel-toggle" onchange="setHooksWriteLabels(this.checked)">
                                <span id="hooks-labels-text" class="toggle-switch-text">Off</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- General tab -->
        <div class="tab-panel" id="tab-general" role="tabpanel">
            <div class="accordion-stack">

                <!-- System Settings -->
                <details class="accordion card" open>
                    <summary class="accordion-header">
                        <svg class="accordion-chevron" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                        <h2>System Settings</h2>
                        <span class="accordion-preview">Port, TLS, logging, instance role</span>
                    </summary>
                    <div class="accordion-body">
                        <div id="general-restart-banner" class="restart-banner-inline" style="display:none">
                            Settings saved — restart the container to apply.
                        </div>
                        <div class="settings-rows">
                            <div class="setting-row">
                                <div class="setting-info">
                                    <div class="setting-label">Web Port</div>
                                    <div class="setting-desc">Dashboard port <span class="restart-badge">Restart required</span></div>
                                </div>
                                <input type="number" id="general-web-port" class="setting-input" style="max-width:120px" min="1" max="65535" onchange="saveGeneralSetting('web_port', this.value)">
                            </div>
                            <div class="setting-row">
                                <div class="setting-info">
                                    <div class="setting-label">TLS</div>
                                    <div class="setting-desc">HTTPS encryption <span class="restart-badge">Restart required</span></div>
                                </div>
                                <select id="general-tls-mode" class="setting-select" onchange="saveGeneralSetting('tls_mode', this.value)">
                                    <option value="off">Off</option>
                                    <option value="auto">Auto (self-signed)</option>
                                    <option value="manual">Manual (provide certs)</option>
                                </select>
                            </div>
                            <div class="setting-row">
                                <div class="setting-info">
                                    <div class="setting-label">Log Format</div>
                                    <div class="setting-desc">Structured JSON or plain text <span class="restart-badge">Restart required</span></div>
                                </div>
                                <select id="general-log-format" class="setting-select" onchange="saveGeneralSetting('log_format', this.value)">
                                    <option value="json">JSON</option>
                                    <option value="text">Plain text</option>
                                </select>
                            </div>
                            <div class="setting-row">
                                <div class="setting-info">
                                    <div class="setting-label">Instance Role</div>
                                    <div class="setting-desc">Currently running as <strong id="general-role-label">server</strong> <span class="restart-badge">Restart required</span></div>
                                </div>
                                <button class="btn btn-sm btn-warning" id="general-switch-role-btn" onclick="switchRole()">Switch to Agent</button>
                            </div>
                        </div>
                    </div>
                </details>

                                <!-- Environment Variables -->
                <details class="accordion card">
                    <summary class="accordion-header">
                        <svg class="accordion-chevron" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                        <h2>Environment Variables</h2>
                        <span class="accordion-preview">Read-only values set via Docker environment</span>
                    </summary>
                    <div class="accordion-body accordion-body-flush">
                        <div class="table-wrap">
                            <table class="table-readonly">
                                <thead><tr><th>Setting</th><th>Value</th></tr></thead>
                                <tbody>
                                    {{range $k, $v := .Settings}}
                                    <tr>
                                        <td class="mono">{{$k}}</td>
                                        <td class="mono">{{$v}}</td>
                                    </tr>
                                    {{end}}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </details>

            </div>
        </div>

        <!-- Notifications tab -->
        <div class="tab-panel" id="tab-notifications" role="tabpanel">
            <div class="accordion-stack">

                <!-- Notification Channels -->
                <details class="accordion card">
                    <summary class="accordion-header">
                        <svg class="accordion-chevron" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                        <h2>Notification Channels</h2>
                        <span class="accordion-preview">Where Sentinel sends alerts</span>
                    </summary>
                    <div class="accordion-body">
                        <div id="channel-list"><!-- JS renders channel cards here --></div>
                        <div class="setting-actions" style="margin-top: var(--sp-4)">
                            <div class="channel-add-wrap">
                                <select id="channel-type-select" class="setting-select">
                                    <option value="">Add notification channel...</option>
                                    <option value="gotify">Gotify</option>
                                    <option value="webhook">Webhook</option>
                                    <option value="slack">Slack</option>
                                    <option value="discord">Discord</option>
                                    <option value="ntfy">Ntfy</option>
                                    <option value="telegram">Telegram</option>
                                    <option value="pushover">Pushover</option>
                                </select>
                                <button class="btn" onclick="addChannel()">Add</button>
                            </div>
                            <button class="btn btn-success" id="notify-save-btn" onclick="saveNotificationChannels()">Save All</button>
                            <button class="btn" id="notify-test-btn" onclick="testNotification()">Test All</button>
                        </div>
                    </div>
                </details>

                <!-- Notification Behaviour -->
                <details class="accordion card">
                    <summary class="accordion-header">
                        <svg class="accordion-chevron" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                        <h2>Notification Behaviour</h2>
                        <span class="accordion-preview" id="notify-mode-preview">Loading...</span>
                    </summary>
                    <div class="accordion-body">
                        <p class="accordion-intro">Choose how Sentinel notifies you when container updates are found. This applies to all containers unless overridden individually below.</p>

                        <div class="notify-options" id="notify-mode-options">
                            <label class="notify-option">
                                <input type="radio" name="default-notify-mode" value="default" onchange="onNotifyModeChange(this.value)">
                                <div class="notify-option-content">
                                    <div class="notify-option-title">Notify immediately + daily summary</div>
                                    <div class="notify-option-desc">Get an alert as soon as an update is detected. You also receive a scheduled summary of all pending updates.</div>
                                </div>
                            </label>
                            <label class="notify-option">
                                <input type="radio" name="default-notify-mode" value="every_scan" onchange="onNotifyModeChange(this.value)">
                                <div class="notify-option-content">
                                    <div class="notify-option-title">Notify on every scan</div>
                                    <div class="notify-option-desc">Get an alert every time a scan finds updates, even if you were already notified about the same update. No scheduled summary.</div>
                                </div>
                            </label>
                            <label class="notify-option">
                                <input type="radio" name="default-notify-mode" value="digest_only" onchange="onNotifyModeChange(this.value)">
                                <div class="notify-option-content">
                                    <div class="notify-option-title">Summary only</div>
                                    <div class="notify-option-desc">No immediate alerts. You only receive a scheduled summary listing all containers with pending updates.</div>
                                </div>
                            </label>
                            <label class="notify-option">
                                <input type="radio" name="default-notify-mode" value="muted" onchange="onNotifyModeChange(this.value)">
                                <div class="notify-option-content">
                                    <div class="notify-option-title">Silent</div>
                                    <div class="notify-option-desc">No notifications of any kind. Check the dashboard manually to see pending updates.</div>
                                </div>
                            </label>
                        </div>

                        <div id="digest-schedule-section" style="display:none">
                            <h3 class="digest-schedule-heading">Summary schedule</h3>
                            <div class="settings-rows">
                                <div class="setting-row">
                                    <div class="setting-info">
                                        <div class="setting-label">Time of day</div>
                                        <div class="setting-desc">When the summary is compiled and sent</div>
                                    </div>
                                    <input type="time" id="digest-time" class="setting-input" style="max-width:160px" value="09:00" onchange="saveDigestSettings()">
                                </div>
                                <div class="setting-row">
                                    <div class="setting-info">
                                        <div class="setting-label">Frequency</div>
                                        <div class="setting-desc">How often the summary is sent</div>
                                    </div>
                                    <select id="digest-interval" class="setting-select" onchange="saveDigestSettings()">
                                        <option value="12h">Every 12 hours</option>
                                        <option value="24h" selected>Every 24 hours</option>
                                        <option value="48h">Every 48 hours</option>
                                        <option value="168h">Weekly</option>
                                    </select>
                                </div>
                                <div class="setting-actions">
                                    <button class="btn" onclick="triggerDigest()">Send Test Summary</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </details>

                <!-- Per-Container Notification Overrides -->
                <details class="accordion card">
                    <summary class="accordion-header">
                        <svg class="accordion-chevron" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                        <h2>Per-Container Overrides</h2>
                        <span class="accordion-preview">Customise notification behaviour for individual containers</span>
                    </summary>
                    <div class="accordion-body">
                        <p class="accordion-intro">Override the default notification mode for specific containers. Containers not listed here use the default mode set above.</p>
                        <div id="container-notify-prefs">
                            <p class="text-muted">Loading...</p>
                        </div>
                    </div>
                </details>

            </div>
        </div>

        <!-- Registries tab -->
        <div class="tab-panel" id="tab-registries" role="tabpanel">
            <div class="accordion-stack">
                <details class="accordion card" open>
                    <summary class="accordion-header">
                        <svg class="accordion-chevron" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                        <h2>Detected Registries</h2>
                        <span class="accordion-preview">Rate limits and authentication status</span>
                    </summary>
                    <div class="accordion-body">
                        <p class="setting-desc" style="margin-bottom:var(--sp-4)">Auto-discovered from your container images. Add credentials for higher rate limits.</p>
                        <div id="registry-status-table"></div>
                        <div id="registry-warnings" style="margin-top:var(--sp-3)"></div>
                    </div>
                </details>
                <details class="accordion card">
                    <summary class="accordion-header">
                        <svg class="accordion-chevron" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                        <h2>Manage Credentials</h2>
                        <span class="accordion-preview">Registry login credentials for authenticated pulls</span>
                    </summary>
                    <div class="accordion-body">
                        <div id="credential-list"></div>
                        <div class="setting-actions" style="margin-top:var(--sp-4)">
                            <div class="channel-add-wrap">
                                <select id="registry-type-select" class="setting-select">
                                    <option value="">Add registry credentials...</option>
                                </select>
                                <button class="btn" onclick="addRegistryCredential()">Add</button>
                            </div>
                            <button class="btn btn-success" onclick="saveRegistryCredentials(event)">Save All</button>
                        </div>
                    </div>
                </details>
                <details class="accordion card">
                    <summary class="accordion-header">
                        <svg class="accordion-chevron" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                        <h2>GHCR Alternatives</h2>
                        <span class="accordion-preview">Docker Hub images also available on GitHub Container Registry</span>
                    </summary>
                    <div class="accordion-body">
                        <p class="setting-desc" style="margin-bottom:var(--sp-4)">Sentinel checks whether your Docker Hub images are also available on GHCR, which has no rate limits.</p>
                        <div id="ghcr-alternatives-table"></div>
                    </div>
                </details>
            </div>
        </div>

        <!-- Appearance tab -->
        <div class="tab-panel" id="tab-appearance" role="tabpanel">
            <div class="accordion-stack">
                <details class="accordion card">
                    <summary class="accordion-header">
                        <svg class="accordion-chevron" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                        <h2>Appearance</h2>
                        <span class="accordion-preview">Theme and layout preferences</span>
                    </summary>
                    <div class="accordion-body">
                        <div class="settings-rows">
                            <div class="setting-row">
                                <div class="setting-info">
                                    <div class="setting-label">Theme</div>
                                    <div class="setting-desc">Choose your colour scheme</div>
                                </div>
                                <select id="theme-select" class="setting-select">
                                    <option value="dark">Dark</option>
                                    <!-- light theme disabled for now -->
                                </select>
                            </div>
                            <div class="setting-row">
                                <div class="setting-info">
                                    <div class="setting-label">Dashboard stacks</div>
                                    <div class="setting-desc">Whether container stacks start collapsed or expanded on the dashboard</div>
                                </div>
                                <select id="stack-default" class="setting-select">
                                    <option value="collapsed">Collapsed</option>
                                    <option value="expanded">Expanded</option>
                                </select>
                            </div>
                            <div class="setting-row">
                                <div class="setting-info">
                                    <div class="setting-label">Default section view</div>
                                    <div class="setting-desc">Whether page sections start collapsed or expanded (your manual changes are remembered)</div>
                                </div>
                                <select id="section-default" class="setting-select">
                                    <option value="remember">Remember my choices</option>
                                    <option value="collapsed">Always collapsed</option>
                                    <option value="expanded">Always expanded</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </details>
            </div>
        </div>

        <!-- Security tab (admin only) -->
        {{if .AuthEnabled}}{{if .CurrentUser}}{{if eq .CurrentUser.RoleID "admin"}}
        <div class="tab-panel" id="tab-security" role="tabpanel">
            <div class="accordion-stack">

                <!-- Authentication -->
                <details class="accordion card">
                    <summary class="accordion-header">
                        <svg class="accordion-chevron" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                        <h2>Authentication</h2>
                        <span class="accordion-preview">Login requirements and access control</span>
                    </summary>
                    <div class="accordion-body">
                        <div class="settings-rows">
                            <div class="setting-row">
                                <div class="setting-info">
                                    <div class="setting-label">Require login</div>
                                    <div class="setting-desc">When disabled, all endpoints are accessible without login</div>
                                </div>
                                <label class="toggle-switch-label">
                                    <input type="checkbox" id="auth-toggle" class="channel-toggle" checked onchange="confirmAuthToggle(this)">
                                    <span class="toggle-switch-text">Enabled</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </details>

                <!-- User Management -->
                <details class="accordion card">
                    <summary class="accordion-header">
                        <svg class="accordion-chevron" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                        <h2>User Management</h2>
                        <span class="accordion-preview">Manage users and roles</span>
                    </summary>
                    <div class="accordion-body accordion-body-flush">
                        <div class="table-wrap">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Username</th>
                                        <th>Role</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="user-list">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </details>

                <!-- Create User -->
                <details class="accordion card">
                    <summary class="accordion-header">
                        <svg class="accordion-chevron" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                        <h2>Create User</h2>
                        <span class="accordion-preview">Add a new user account</span>
                    </summary>
                    <div class="accordion-body">
                        <div class="settings-rows">
                            <div class="setting-row">
                                <div class="setting-info">
                                    <div class="setting-label">Username</div>
                                </div>
                                <input type="text" id="new-user-username" class="setting-select" placeholder="username" autocomplete="off">
                            </div>
                            <div class="setting-row">
                                <div class="setting-info">
                                    <div class="setting-label">Password</div>
                                    <div class="setting-desc">Min 8 characters, at least one letter and one digit</div>
                                </div>
                                <input type="password" id="new-user-password" class="setting-select" placeholder="password" autocomplete="new-password">
                            </div>
                            <div class="setting-row">
                                <div class="setting-info">
                                    <div class="setting-label">Role</div>
                                </div>
                                <select id="new-user-role" class="setting-select">
                                    <option value="viewer">viewer</option>
                                    <option value="operator">operator</option>
                                    <option value="admin">admin</option>
                                </select>
                            </div>
                            <div class="setting-row" style="justify-content:flex-end">
                                <button class="btn btn-success" onclick="createUser()">Create User</button>
                            </div>
                        </div>
                    </div>
                </details>

            </div>
        </div>
        {{end}}{{end}}{{end}}

        <!-- Cluster tab -->
        <div class="tab-panel" id="tab-cluster" role="tabpanel">
            <div class="card">
                <div class="card-header">
                    <h2>Multi-Host Monitoring</h2>
                </div>
                <div class="card-body" style="padding: var(--sp-4) var(--sp-5)">
                    <p class="accordion-intro">Monitor containers across multiple Docker hosts using lightweight agents that report back over encrypted gRPC (mTLS).</p>
                    <div class="settings-rows">
                        <div class="setting-row">
                            <div class="setting-info">
                                <div class="setting-label">Enable cluster mode</div>
                                <div class="setting-desc">Starts a gRPC server for agent connections. No container restart needed.</div>
                            </div>
                            <label class="toggle-switch-label">
                                <input type="checkbox" id="cluster-enabled" class="channel-toggle" onchange="onClusterToggle(this.checked)">
                                <span id="cluster-enabled-text" class="toggle-switch-text">Off</span>
                            </label>
                        </div>
                    </div>

                    <div id="cluster-fields" class="cluster-fields disabled">
                        <div class="settings-rows">
                            <div class="setting-row">
                                <div class="setting-info">
                                    <div class="setting-label">gRPC port</div>
                                    <div class="setting-desc">Port for agent connections. Change requires restart.</div>
                                </div>
                                <input type="number" id="cluster-port" class="setting-input" style="max-width:120px" value="9443" min="1024" max="65535" onchange="saveClusterSettings()">
                            </div>
                            <div class="setting-row">
                                <div class="setting-info">
                                    <div class="setting-label">Grace period</div>
                                    <div class="setting-desc">How long agents wait before entering autonomous mode when this server is unreachable.</div>
                                </div>
                                <select id="cluster-grace" class="setting-select" onchange="saveClusterSettings()">
                                    <option value="5m">5 minutes</option>
                                    <option value="15m">15 minutes</option>
                                    <option value="30m" selected>30 minutes</option>
                                    <option value="1h">1 hour</option>
                                    <option value="2h">2 hours</option>
                                </select>
                            </div>
                            <div class="setting-row">
                                <div class="setting-info">
                                    <div class="setting-label">Default remote policy</div>
                                    <div class="setting-desc">Update policy applied to containers discovered on newly enrolled hosts.</div>
                                </div>
                                <select id="cluster-policy" class="setting-select" onchange="saveClusterSettings()">
                                    <option value="manual" selected>manual</option>
                                    <option value="auto">auto</option>
                                    <option value="pinned">pinned</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- About tab -->
        <div class="tab-panel" id="tab-about" role="tabpanel">
            <div class="card">
                <div class="card-body" style="padding: var(--sp-4) var(--sp-5)">
                    <div id="about-content">
                        <p class="text-muted">Loading...</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="toast-container" class="toast-container"></div>
    <script src="/static/app.js"></script>
    <script src="/static/auth.js"></script>
    <script>
// General settings
function saveGeneralSetting(key, value) {
    fetch('/api/settings/general', {
        method: 'POST',
        headers: {'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken},
        body: JSON.stringify({key: key, value: value})
    })
    .then(function(r) { return r.json(); })
    .then(function(d) {
        if (d.error) { showToast(d.error, 'error'); return; }
        showToast('Setting saved');
        document.getElementById('general-restart-banner').style.display = 'block';
    })
    .catch(function() { showToast('Failed to save', 'error'); });
}

function switchRole() {
    if (!confirm('Switch this instance to agent mode? This will take effect after a container restart.')) return;
    fetch('/api/settings/switch-role', {
        method: 'POST',
        headers: {'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken},
        body: JSON.stringify({role: 'agent'})
    })
    .then(function(r) { return r.json(); })
    .then(function(d) {
        if (d.error) { showToast(d.error, 'error'); return; }
        showToast('Role saved — restart to apply');
        document.getElementById('general-role-label').textContent = 'agent';
        document.getElementById('general-switch-role-btn').textContent = 'Switch to Server';
        document.getElementById('general-restart-banner').style.display = 'block';
    })
    .catch(function() { showToast('Failed to save', 'error'); });
}

// Load current values
(function() {
    fetch('/api/settings')
        .then(function(r) { return r.json(); })
        .then(function(d) {
            var port = document.getElementById('general-web-port');
            if (port) port.value = d['SENTINEL_WEB_PORT'] || d['web_port'] || '8080';

            var tls = document.getElementById('general-tls-mode');
            if (tls) {
                var mode = d['tls_mode'] || 'off';
                if (!d['tls_mode']) {
                    if (d['SENTINEL_TLS_AUTO'] === 'true') mode = 'auto';
                    else if (d['SENTINEL_TLS_CERT'] && d['SENTINEL_TLS_CERT'] !== '') mode = 'manual';
                }
                tls.value = mode;
            }

            var log = document.getElementById('general-log-format');
            if (log) {
                var fmt = d['log_format'] || (d['SENTINEL_LOG_JSON'] === 'true' ? 'json' : 'text');
                log.value = fmt;
            }

            var role = document.getElementById('general-role-label');
            var roleBtn = document.getElementById('general-switch-role-btn');
            var currentRole = d['instance_role'] || 'server';
            if (role) role.textContent = currentRole;
            if (roleBtn) {
                roleBtn.textContent = currentRole === 'agent' ? 'Switch to Server' : 'Switch to Agent';
            }
        });
})();
    </script>
</body>
</html>
{{end}}
