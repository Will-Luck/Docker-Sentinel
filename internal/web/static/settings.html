{{define "settings.html"}}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings — Docker-Sentinel</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png">
    <link rel="apple-touch-icon" href="/static/apple-touch-icon.png">
</head>
<body>
    <a href="#main-content" class="skip-link">Skip to main content</a>
    <nav class="nav">
        <a href="/" class="nav-brand">
            <img src="/favicon.svg" alt="S" class="nav-logo">
            <span class="nav-brand-text">Sentinel</span>
        </a>
        <div class="nav-links">
            <a href="/" class="nav-link">Dashboard</a>
            <a href="/queue" class="nav-link">
                Pending Updates
                {{if .QueueCount}}<span class="nav-badge">{{.QueueCount}}</span>{{end}}
            </a>
            <a href="/history" class="nav-link">History</a>
            <a href="/logs" class="nav-link">Logs</a>
            <a href="/images" class="nav-link">Images</a>
            <a href="/settings" class="nav-link active" aria-current="page">Settings</a>
            {{if .ClusterEnabled}}<a href="/cluster" class="nav-link{{if eq .Page "cluster"}} active{{end}}">Cluster</a>{{end}}
            {{if .PortainerEnabled}}<a href="/portainer" class="nav-link">Portainer</a>{{end}}
        </div>
        <div class="nav-status" aria-live="polite">
            <span id="sse-indicator" class="status-dot disconnected"></span>
            <span id="sse-label" class="nav-status-text">Disconnected</span>
        </div>
        {{if .AuthEnabled}}{{if .CurrentUser}}
        <div class="nav-user">
            <button class="nav-user-btn" onclick="toggleUserDropdown(event)" aria-haspopup="true" aria-expanded="false">
                <span>{{.CurrentUser.Username}}</span>
                <span class="nav-user-role">{{.CurrentUser.RoleID}}</span>
                <span class="nav-user-chevron">&#9662;</span>
            </button>
            <div class="nav-user-dropdown" id="user-dropdown">
                <a href="/account">My Account</a>
                <div class="dropdown-divider"></div>
                <form method="POST" action="/logout" style="margin:0">
                    <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
                    <button type="submit">Logout</button>
                </form>
            </div>
        </div>
        {{end}}{{else}}
        <a href="/settings" class="nav-auth-off" onclick="localStorage.setItem('sentinel-settings-tab','security')">Auth: Off</a>
        {{end}}
    </nav>

    <main class="main-content" id="main-content">
        <div class="page-header">
            <div>
                <h1>Settings</h1>
                <p class="subtitle">Configure Sentinel behaviour and notifications</p>
            </div>
        </div>

        <div class="tab-nav" role="tablist">
            <button class="tab-btn active" role="tab" aria-selected="true" aria-controls="tab-scanning" data-tab="scanning">Scanning</button>
            <button class="tab-btn" role="tab" aria-selected="false" aria-controls="tab-notifications" data-tab="notifications">Notifications</button>
            <button class="tab-btn" role="tab" aria-selected="false" aria-controls="tab-registries" data-tab="registries">Registries</button>
            <button class="tab-btn" role="tab" aria-selected="false" aria-controls="tab-appearance" data-tab="appearance">Appearance</button>
            <button class="tab-btn" role="tab" aria-selected="false" aria-controls="tab-general" data-tab="general">General</button>
            <button class="tab-btn" role="tab" aria-selected="false" aria-controls="tab-cluster" data-tab="cluster">Cluster</button>
            <button class="tab-btn" role="tab" aria-selected="false" aria-controls="tab-portainer" data-tab="portainer">Portainer</button>
            <button class="tab-btn" role="tab" aria-selected="false" aria-controls="tab-about" data-tab="about">About</button>
            {{if .ShowSecurityTab}}
            <button class="tab-btn" role="tab" aria-selected="false" aria-controls="tab-security" data-tab="security">Security</button>
            {{end}}
        </div>

        <!-- Scanning tab -->
        <div class="tab-panel active" id="tab-scanning" role="tabpanel">
            <div class="accordion-stack">

                <details class="accordion card" open>
                    <summary class="accordion-header">
                        <svg class="accordion-chevron" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                        <h2>Scan Schedule</h2>
                        <span class="accordion-preview" id="scan-schedule-preview">Loading...</span>
                    </summary>
                    <div class="accordion-body">
                        <div class="settings-rows">
                            <div class="setting-row">
                                <div class="setting-info">
                                    <div class="setting-label">Poll interval</div>
                                    <div class="setting-desc">How often Sentinel checks for container updates</div>
                                </div>
                                <div class="poll-interval-control">
                                    <select id="poll-interval" class="setting-select" onchange="onPollIntervalChange(this.value)">
                                        <option value="15m">15 minutes</option>
                                        <option value="30m">30 minutes</option>
                                        <option value="1h">1 hour</option>
                                        <option value="6h">6 hours</option>
                                        <option value="12h">12 hours</option>
                                        <option value="24h">24 hours</option>
                                        <option value="custom">Custom...</option>
                                    </select>
                                    <div id="poll-custom-wrap" class="custom-duration-wrap" style="display:none">
                                        <select id="poll-custom-unit" class="setting-select custom-duration-unit" onchange="onCustomUnitChange('poll')">
                                            <option value="">Unit...</option>
                                            <option value="s">Seconds</option>
                                            <option value="m">Minutes</option>
                                            <option value="h">Hours</option>
                                        </select>
                                        <input id="poll-custom-value" type="number" class="setting-select custom-duration-value" min="1" placeholder="Value" disabled>
                                        <button id="poll-custom-btn" class="btn btn-success" onclick="applyCustomPollInterval()" disabled>Apply</button>
                                    </div>
                                </div>
                            </div>
                            <div class="setting-row">
                                <div class="setting-info">
                                    <div class="setting-label">Cron schedule</div>
                                    <div class="setting-desc">Use a cron expression instead of the poll interval (leave empty to use poll interval)</div>
                                </div>
                                <div class="poll-interval-control">
                                    <input type="text" id="cron-schedule" class="setting-select" placeholder="e.g. 0 3 * * *" style="max-width:220px">
                                    <button class="btn btn-success" onclick="saveCronSchedule()">Apply</button>
                                </div>
                            </div>
                            <div class="setting-row">
                                <div class="setting-info">
                                    <div class="setting-label">Pause scanning</div>
                                    <div class="setting-desc">Temporarily stop all automatic update checks</div>
                                </div>
                                <label class="toggle-switch-label">
                                    <input type="checkbox" id="pause-toggle" class="channel-toggle" onchange="setPauseState(this.checked)">
                                    <span id="pause-toggle-text" class="toggle-switch-text">Off</span>
                                </label>
                            </div>
                            <div class="setting-row">
                                <div class="setting-info">
                                    <div class="setting-label">Scan concurrency</div>
                                    <div class="setting-desc">Number of parallel registry checks per scan (1 = sequential). Experimental.</div>
                                </div>
                                <div style="display:flex;align-items:center;gap:var(--sp-2)">
                                    <input type="number" id="scan-concurrency-input" class="setting-input" min="1" max="20" value="1" style="width:5rem">
                                    <button class="btn btn-sm btn-secondary" onclick="setScanConcurrency()">Save</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </details>

                <details class="accordion card" open>
                    <summary class="accordion-header">
                        <svg class="accordion-chevron" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                        <h2>Update Policy</h2>
                        <span class="accordion-preview" id="update-policy-preview">Loading...</span>
                    </summary>
                    <div class="accordion-body">
                        <div class="settings-rows">
                            <div class="setting-row">
                                <div class="setting-info">
                                    <div class="setting-label">Default policy</div>
                                    <div class="setting-desc">Policy assigned to containers without a sentinel.policy label</div>
                                </div>
                                <select id="default-policy" class="setting-select" onchange="setDefaultPolicy(this.value)">
                                    <option value="auto">auto</option>
                                    <option value="manual">manual</option>
                                    <option value="pinned">pinned</option>
                                </select>
                            </div>
                            <div class="setting-row">
                                <div class="setting-info">
                                    <div class="setting-label">Auto-update :latest containers</div>
                                    <div class="setting-desc">Containers using the :latest tag are set to auto-update, regardless of the default policy above</div>
                                </div>
                                <label class="toggle-switch-label">
                                    <input type="checkbox" id="latest-auto-toggle" class="channel-toggle" onchange="setLatestAutoUpdate(this.checked)">
                                    <span id="latest-auto-text" class="toggle-switch-text">On</span>
                                </label>
                            </div>
                            <div class="setting-row">
                                <div class="setting-info">
                                    <div class="setting-label">On Rollback</div>
                                    <div class="setting-desc">Automatically change update policy when a service or container rolls back, preventing the same broken update from being retried</div>
                                </div>
                                <select id="rollback-policy" class="setting-select" onchange="setRollbackPolicy(this.value)">
                                    <option value="">No change</option>
                                    <option value="manual">Set to Manual</option>
                                    <option value="pinned">Set to Pinned</option>
                                </select>
                            </div>
                            <div class="setting-row">
                                <div class="setting-info">
                                    <div class="setting-label">Grace period</div>
                                    <div class="setting-desc">Time to wait after an update before checking container health</div>
                                </div>
                                <div class="poll-interval-control">
                                    <select id="grace-period" class="setting-select" onchange="onGracePeriodChange(this.value)">
                                        <option value="10s">10 seconds</option>
                                        <option value="15s">15 seconds</option>
                                        <option value="30s">30 seconds</option>
                                        <option value="1m0s">60 seconds</option>
                                        <option value="2m0s">120 seconds</option>
                                        <option value="custom">Custom...</option>
                                    </select>
                                    <div id="grace-custom-wrap" class="custom-duration-wrap" style="display:none">
                                        <select id="grace-custom-unit" class="setting-select custom-duration-unit" onchange="onCustomUnitChange('grace')">
                                            <option value="">Unit...</option>
                                            <option value="s">Seconds</option>
                                            <option value="m">Minutes</option>
                                            <option value="h">Hours</option>
                                        </select>
                                        <input id="grace-custom-value" type="number" class="setting-select custom-duration-value" min="1" placeholder="Value" disabled>
                                        <button id="grace-custom-btn" class="btn btn-success" onclick="applyCustomGracePeriod()" disabled>Apply</button>
                                    </div>
                                </div>
                            </div>
                            <div class="setting-row">
                                <div class="setting-info">
                                    <div class="setting-label">Update delay</div>
                                    <div class="setting-desc">Wait this long after first detecting an update before applying it. Per-container: <code>sentinel.delay</code> label (e.g. <code>72h</code>, <code>3d</code>)</div>
                                </div>
                                <div class="poll-interval-control">
                                    <input type="text" id="update-delay" class="setting-select" placeholder="e.g. 72h, 3d" style="max-width:120px">
                                    <button class="btn btn-success" onclick="setUpdateDelay()">Save</button>
                                </div>
                            </div>
                            <div class="setting-row">
                                <div class="setting-info">
                                    <div class="setting-label">Maintenance window</div>
                                    <div class="setting-desc">Time window when auto-updates are applied. Scans still run on schedule, but updates are deferred until inside the window. Manual approvals always bypass.</div>
                                    <div class="setting-hint" style="margin-top:0.25rem;font-size:0.8rem;color:var(--text-muted)">Formats: <code>HH:MM-HH:MM</code> (daily), <code>Sat 02:00-Sat 06:00</code> (weekly), multiple with <code>;</code></div>
                                </div>
                                <div class="poll-interval-control">
                                    <input type="text" id="maintenance-window" class="setting-select" placeholder="e.g. 02:00-06:00" style="max-width:220px">
                                    <button class="btn btn-success" onclick="saveMaintenanceWindow()">Save</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </details>

                <details class="accordion card">
                    <summary class="accordion-header">
                        <svg class="accordion-chevron" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                        <h2>Container Scope</h2>
                        <span class="accordion-preview">Filters, visibility, and dependencies</span>
                    </summary>
                    <div class="accordion-body">
                        <div class="settings-rows">
                            <div class="setting-row setting-row-top">
                                <div class="setting-info">
                                    <div class="setting-label">Container filters</div>
                                    <div class="setting-desc">Exclude containers matching these patterns (one per line)</div>
                                </div>
                                <div class="setting-control-stack">
                                    <textarea id="container-filters" class="setting-textarea" placeholder="e.g. watchtower&#10;test-*"></textarea>
                                    <button class="btn btn-success" onclick="saveFilters()">Save Filters</button>
                                </div>
                            </div>
                            <div class="setting-row">
                                <div class="setting-info">
                                    <div class="setting-label">Show stopped containers</div>
                                    <div class="setting-desc">Display stopped containers in the dashboard. Stopped containers are not scanned for updates.</div>
                                </div>
                                <label class="toggle-switch-label">
                                    <input type="checkbox" id="show-stopped-toggle" class="channel-toggle" onchange="setShowStopped(this.checked)">
                                    <span id="show-stopped-text" class="toggle-switch-text">Off</span>
                                </label>
                            </div>
                            <div class="setting-row">
                                <div class="setting-info">
                                    <div class="setting-label">Dependency-aware updates</div>
                                    <div class="setting-desc">Restart containers that depend on an updated container (via labels or network mode)</div>
                                </div>
                                <label class="toggle-switch-label">
                                    <input type="checkbox" id="dep-aware-toggle" class="channel-toggle" onchange="setDependencyAware(this.checked)">
                                    <span id="dep-aware-text" class="toggle-switch-text">On</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </details>

                <details class="accordion card">
                    <summary class="accordion-header">
                        <svg class="accordion-chevron" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                        <h2>Update Process</h2>
                        <span class="accordion-preview">Modes, cleanup, and backups</span>
                    </summary>
                    <div class="accordion-body">
                        <div class="settings-rows">
                            <div class="setting-row">
                                <div class="setting-info">
                                    <div class="setting-label">Dry-run mode</div>
                                    <div class="setting-desc">Detect updates and send notifications without actually updating containers</div>
                                </div>
                                <label class="toggle-switch-label">
                                    <input type="checkbox" id="dry-run-toggle" class="channel-toggle" onchange="setDryRun(this.checked)">
                                    <span id="dry-run-text" class="toggle-switch-text">Off</span>
                                </label>
                            </div>
                            <div class="setting-row">
                                <div class="setting-info">
                                    <div class="setting-label">Pull-only mode</div>
                                    <div class="setting-desc">Pull the new image without restarting containers (pre-stage updates). Override per container with <code>sentinel.pull-only=true</code></div>
                                </div>
                                <label class="toggle-switch-label">
                                    <input type="checkbox" id="pull-only-toggle" class="channel-toggle" onchange="setPullOnly(this.checked)">
                                    <span id="pull-only-text" class="toggle-switch-text">Off</span>
                                </label>
                            </div>
                            <div class="setting-row">
                                <div class="setting-info">
                                    <div class="setting-label">Image cleanup</div>
                                    <div class="setting-desc">Automatically remove old images after a successful update</div>
                                </div>
                                <label class="toggle-switch-label">
                                    <input type="checkbox" id="image-cleanup-toggle" class="channel-toggle" onchange="setImageCleanup(this.checked)">
                                    <span id="image-cleanup-text" class="toggle-switch-text">On</span>
                                </label>
                            </div>
                            <div class="setting-row">
                                <div class="setting-info">
                                    <div class="setting-label">Image backup before update</div>
                                    <div class="setting-desc">Retag the current image as <code>:sentinel-backup-YYYYMMDD-HHmmss</code> before pulling a new one</div>
                                </div>
                                <label class="toggle-switch-label">
                                    <input type="checkbox" id="image-backup-toggle" class="channel-toggle" onchange="setImageBackup(this.checked)">
                                    <span id="image-backup-text" class="toggle-switch-text">Off</span>
                                </label>
                            </div>
                            <div class="setting-row">
                                <div class="setting-info">
                                    <div class="setting-label">Remove volumes on update</div>
                                    <div class="setting-desc">Remove anonymous volumes when replacing a container. Can also be set per-container with <code>sentinel.remove-volumes=true</code>.</div>
                                </div>
                                <label class="toggle-switch-label">
                                    <input type="checkbox" id="remove-volumes-toggle" class="channel-toggle" onchange="setRemoveVolumes(this.checked)">
                                    <span id="remove-volumes-text" class="toggle-switch-text">Off</span>
                                </label>
                            </div>
                            <div class="setting-row">
                                <div class="setting-info">
                                    <div class="setting-label">Compose file sync</div>
                                    <div class="setting-desc">Update the image tag in the Docker Compose file after a successful update. Only applies to Compose-managed containers. Creates <code>.bak</code> backups before modifying.</div>
                                </div>
                                <label class="toggle-switch-label">
                                    <input type="checkbox" id="compose-sync-toggle" class="channel-toggle" onchange="setComposeSync(this.checked)">
                                    <span id="compose-sync-text" class="toggle-switch-text">Off</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </details>

                <details class="accordion card">
                    <summary class="accordion-header">
                        <svg class="accordion-chevron" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                        <h2>Lifecycle Hooks</h2>
                        <span class="accordion-preview">Pre/post-update commands</span>
                    </summary>
                    <div class="accordion-body">
                        <div class="settings-rows">
                            <div class="setting-row">
                                <div class="setting-info">
                                    <div class="setting-label">Lifecycle hooks</div>
                                    <div class="setting-desc">Run pre-update and post-update commands inside containers during updates</div>
                                </div>
                                <label class="toggle-switch-label">
                                    <input type="checkbox" id="hooks-toggle" class="channel-toggle" onchange="setHooksEnabled(this.checked)">
                                    <span id="hooks-toggle-text" class="toggle-switch-text">Off</span>
                                </label>
                            </div>
                            <div class="setting-row">
                                <div class="setting-info">
                                    <div class="setting-label">Write hook labels</div>
                                    <div class="setting-desc">Persist hook configurations as container labels for portability</div>
                                </div>
                                <label class="toggle-switch-label">
                                    <input type="checkbox" id="hooks-labels-toggle" class="channel-toggle" onchange="setHooksWriteLabels(this.checked)">
                                    <span id="hooks-labels-text" class="toggle-switch-text">Off</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </details>

            </div>
        </div>

        <!-- General tab -->
        <div class="tab-panel" id="tab-general" role="tabpanel">
            <div class="accordion-stack">

                <!-- System Settings -->
                <details class="accordion card" open>
                    <summary class="accordion-header">
                        <svg class="accordion-chevron" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                        <h2>System Settings</h2>
                        <span class="accordion-preview">Port, TLS, logging, instance role</span>
                    </summary>
                    <div class="accordion-body">
                        <div id="general-restart-banner" class="restart-banner-inline" style="display:none">
                            Settings saved — restart the container to apply.
                        </div>
                        <div class="settings-rows">
                            <div class="setting-row">
                                <div class="setting-info">
                                    <div class="setting-label">Web Port</div>
                                    <div class="setting-desc">Dashboard port <span class="restart-badge">Restart required</span></div>
                                </div>
                                <input type="number" id="general-web-port" class="setting-input" style="max-width:120px" min="1" max="65535" onchange="saveGeneralSetting('web_port', this.value)">
                            </div>
                            <div class="setting-row">
                                <div class="setting-info">
                                    <div class="setting-label">TLS</div>
                                    <div class="setting-desc">HTTPS encryption <span class="restart-badge">Restart required</span></div>
                                </div>
                                <select id="general-tls-mode" class="setting-select" onchange="saveGeneralSetting('tls_mode', this.value)">
                                    <option value="off">Off</option>
                                    <option value="auto">Auto (self-signed)</option>
                                    <option value="manual">Manual (provide certs)</option>
                                </select>
                            </div>
                            <div class="setting-row">
                                <div class="setting-info">
                                    <div class="setting-label">Log Format</div>
                                    <div class="setting-desc">Structured JSON or plain text <span class="restart-badge">Restart required</span></div>
                                </div>
                                <select id="general-log-format" class="setting-select" onchange="saveGeneralSetting('log_format', this.value)">
                                    <option value="json">JSON</option>
                                    <option value="text">Plain text</option>
                                </select>
                            </div>
                            <div class="setting-row">
                                <div class="setting-info">
                                    <div class="setting-label">Instance Role</div>
                                    <div class="setting-desc">Currently running as <strong id="general-role-label">server</strong> <span class="restart-badge">Restart required</span></div>
                                </div>
                                <button class="btn btn-sm btn-warning" id="general-switch-role-btn" onclick="switchRole()">Switch to Agent</button>
                            </div>
                            <div class="setting-row">
                                <div class="setting-info">
                                    <div class="setting-label">Grafana dashboard</div>
                                    <div class="setting-desc">Pre-built dashboard for Prometheus metrics. Import into Grafana to visualise Sentinel metrics.</div>
                                </div>
                                <a href="/api/grafana-dashboard" class="btn btn-sm" download>Download Dashboard JSON</a>
                            </div>
                        </div>
                    </div>
                </details>

                <!-- Docker Connection -->
                <details class="accordion card">
                    <summary class="accordion-header">
                        <svg class="accordion-chevron" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                        <h2>Docker Connection</h2>
                        <span class="accordion-preview">TLS certificates for socket proxy</span>
                    </summary>
                    <div class="accordion-body">
                        <div class="settings-rows">
                            <div class="setting-row setting-row-top">
                                <div class="setting-info">
                                    <div class="setting-label">TLS Certificates</div>
                                    <div class="setting-desc">Configure mTLS certificates for connecting to a Docker socket proxy. Leave all fields empty for direct socket or unencrypted TCP. <span class="restart-badge">Restart required</span></div>
                                </div>
                                <div class="setting-control-stack">
                                    <label class="setting-input-label" for="docker-tls-ca">CA Certificate Path</label>
                                    <input type="text" id="docker-tls-ca" class="setting-input" placeholder="/path/to/ca.pem">
                                    <label class="setting-input-label" for="docker-tls-cert">Client Certificate Path</label>
                                    <input type="text" id="docker-tls-cert" class="setting-input" placeholder="/path/to/cert.pem">
                                    <label class="setting-input-label" for="docker-tls-key">Client Key Path</label>
                                    <input type="text" id="docker-tls-key" class="setting-input" placeholder="/path/to/key.pem">
                                    <div style="display:flex; gap:var(--sp-2); margin-top:var(--sp-2)">
                                        <button class="btn btn-success" onclick="saveDockerTLS()">Save</button>
                                        <button class="btn btn-sm" id="docker-tls-test-btn" onclick="testDockerTLS()">Test Connection</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </details>

                <!-- Inbound Webhooks -->
                <details class="accordion card">
                    <summary class="accordion-header">
                        <svg class="accordion-chevron" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                        <h2>Inbound Webhooks</h2>
                        <span class="accordion-preview">Trigger scans from Docker Hub, GHCR, or CI/CD</span>
                    </summary>
                    <div class="accordion-body">
                        <p class="settings-section-desc">Receive push notifications from Docker Hub, GHCR, or CI/CD pipelines to trigger immediate scans when images are updated.</p>
                        <div class="settings-rows">
                            <div class="setting-row">
                                <div class="setting-info">
                                    <div class="setting-label">Enable Webhooks</div>
                                    <div class="setting-desc">Accept inbound webhook requests to trigger scans</div>
                                </div>
                                <label class="toggle-switch-label">
                                    <input type="checkbox" id="webhook-enabled-toggle" onchange="setWebhookEnabled(this.checked)">
                                    <span id="webhook-enabled-text" class="toggle-switch-text">Off</span>
                                </label>
                            </div>
                        </div>
                        <div id="webhook-config" style="display:none; margin-top:var(--sp-4)">
                            <div class="settings-rows">
                                <div class="setting-row setting-row-top">
                                    <div class="setting-info">
                                        <div class="setting-label">Webhook URL</div>
                                        <div class="setting-desc">POST requests to this URL will trigger a scan</div>
                                    </div>
                                    <div class="setting-control-stack">
                                        <div style="display:flex; gap:var(--sp-2); align-items:center; width:100%">
                                            <input type="text" id="webhook-url" class="setting-input" readonly style="max-width:none; flex:1">
                                            <button class="btn btn-sm" onclick="copyWebhookURL()">Copy</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="setting-row setting-row-top">
                                    <div class="setting-info">
                                        <div class="setting-label">Webhook Secret</div>
                                        <div class="setting-desc">
                                            Append <code>?secret=YOUR_SECRET</code> to the URL, or send it in the <code>X-Webhook-Secret</code> header
                                        </div>
                                    </div>
                                    <div class="setting-control-stack">
                                        <div style="display:flex; gap:var(--sp-2); align-items:center; width:100%">
                                            <input type="text" id="webhook-secret" class="setting-input mono" readonly style="max-width:none; flex:1">
                                            <button class="btn btn-sm" onclick="copyWebhookSecret()">Copy</button>
                                            <button class="btn btn-sm btn-warning" onclick="regenerateWebhookSecret()">Regenerate</button>
                                        </div>
                                        <small id="webhook-secret-hint" class="text-muted" style="display:none">Secret is masked for security. Click Regenerate to create a new one (shown only once).</small>
                                    </div>
                                </div>
                            </div>
                            <details style="margin-top:var(--sp-4)">
                                <summary style="cursor:pointer; font-size:0.85rem; color:var(--fg-secondary); font-weight:500">Supported Payload Formats</summary>
                                <div style="margin-top:var(--sp-2); font-size:0.8rem; color:var(--fg-secondary); line-height:1.6">
                                    <p><strong>Generic:</strong> <code>{"image": "nginx", "tag": "latest"}</code> or <code>{"image": "nginx:latest"}</code></p>
                                    <p><strong>Docker Hub:</strong> Automatic &mdash; point Docker Hub's webhook URL here.</p>
                                    <p><strong>GHCR:</strong> Set up a GitHub webhook with the <code>package</code> event type.</p>
                                </div>
                            </details>
                        </div>
                    </div>
                </details>

                                <!-- Environment Variables -->
                <details class="accordion card">
                    <summary class="accordion-header">
                        <svg class="accordion-chevron" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                        <h2>Environment Variables</h2>
                        <span class="accordion-preview">Read-only values set via Docker environment</span>
                    </summary>
                    <div class="accordion-body accordion-body-flush">
                        <div class="table-wrap">
                            <table class="table-readonly">
                                <thead><tr><th>Setting</th><th>Value</th></tr></thead>
                                <tbody>
                                    {{range $k, $v := .Settings}}
                                    <tr>
                                        <td class="mono">{{$k}}</td>
                                        <td class="mono">{{$v}}</td>
                                    </tr>
                                    {{end}}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </details>

                <!-- Backup & Restore -->
                <details class="accordion card">
                    <summary class="accordion-header">
                        <svg class="accordion-chevron" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                        <h2>Backup &amp; Restore</h2>
                        <span class="accordion-preview">Export and import full configuration</span>
                    </summary>
                    <div class="accordion-body">
                        <p class="settings-section-desc">Export all settings, notification channels, and registry credentials as a JSON backup file. Import to restore or migrate to another instance.</p>
                        <div class="settings-rows">
                            <div class="setting-row setting-row-top">
                                <div class="setting-info">
                                    <div class="setting-label">Export Configuration</div>
                                    <div class="setting-desc">Download a JSON file containing all current settings</div>
                                </div>
                                <div class="setting-control-stack">
                                    <div style="display:flex; gap:var(--sp-2); align-items:center">
                                        <button class="btn btn-success" onclick="exportConfig()">Export</button>
                                        <label class="toggle-switch-label" style="margin-left:var(--sp-2)">
                                            <input type="checkbox" id="export-secrets-toggle">
                                            <span>Include secrets</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="setting-row setting-row-top">
                                <div class="setting-info">
                                    <div class="setting-label">Import Configuration</div>
                                    <div class="setting-desc">Merge import &mdash; existing settings not in the backup are preserved. Redacted values are skipped.</div>
                                </div>
                                <div class="setting-control-stack">
                                    <input type="file" id="config-import-file" accept=".json" class="setting-input" style="max-width:none">
                                    <div style="margin-top:var(--sp-2)">
                                        <button class="btn btn-warning" onclick="importConfig()">Import</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </details>

            </div>
        </div>

        <!-- Notifications tab -->
        <div class="tab-panel" id="tab-notifications" role="tabpanel">
            <div class="accordion-stack">

                <!-- Notification Channels -->
                <details class="accordion card">
                    <summary class="accordion-header">
                        <svg class="accordion-chevron" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                        <h2>Notification Channels</h2>
                        <span class="accordion-preview">Where Sentinel sends alerts</span>
                    </summary>
                    <div class="accordion-body">
                        <div id="channel-list"><!-- JS renders channel cards here --></div>
                        <div class="setting-actions" style="margin-top: var(--sp-4)">
                            <div class="channel-add-wrap">
                                <select id="channel-type-select" class="setting-select">
                                    <option value="">Add notification channel...</option>
                                    <option value="gotify">Gotify</option>
                                    <option value="webhook">Webhook</option>
                                    <option value="slack">Slack</option>
                                    <option value="discord">Discord</option>
                                    <option value="ntfy">Ntfy</option>
                                    <option value="telegram">Telegram</option>
                                    <option value="pushover">Pushover</option>
                                    <option value="smtp">Email (SMTP)</option>
                                    <option value="apprise">Apprise</option>
                                    <option value="mqtt">MQTT</option>
                                </select>
                                <button class="btn" onclick="addChannel()">Add</button>
                            </div>
                            <button class="btn btn-success" id="notify-save-btn" onclick="saveNotificationChannels()">Save All</button>
                            <button class="btn" id="notify-test-btn" onclick="testNotification()">Test All</button>
                        </div>
                    </div>
                </details>

                <!-- Notification Behaviour -->
                <details class="accordion card">
                    <summary class="accordion-header">
                        <svg class="accordion-chevron" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                        <h2>Notification Behaviour</h2>
                        <span class="accordion-preview" id="notify-mode-preview">Loading...</span>
                    </summary>
                    <div class="accordion-body">
                        <p class="accordion-intro">Choose how Sentinel notifies you when container updates are found. This applies to all containers unless overridden individually below.</p>

                        <div class="notify-options" id="notify-mode-options">
                            <label class="notify-option">
                                <input type="radio" name="default-notify-mode" value="default" onchange="onNotifyModeChange(this.value)">
                                <div class="notify-option-content">
                                    <div class="notify-option-title">Notify immediately + daily summary</div>
                                    <div class="notify-option-desc">Get an alert as soon as an update is detected. You also receive a scheduled summary of all pending updates.</div>
                                </div>
                            </label>
                            <label class="notify-option">
                                <input type="radio" name="default-notify-mode" value="every_scan" onchange="onNotifyModeChange(this.value)">
                                <div class="notify-option-content">
                                    <div class="notify-option-title">Notify on every scan</div>
                                    <div class="notify-option-desc">Get an alert every time a scan finds updates, even if you were already notified about the same update. No scheduled summary.</div>
                                </div>
                            </label>
                            <label class="notify-option">
                                <input type="radio" name="default-notify-mode" value="digest_only" onchange="onNotifyModeChange(this.value)">
                                <div class="notify-option-content">
                                    <div class="notify-option-title">Summary only</div>
                                    <div class="notify-option-desc">No immediate alerts. You only receive a scheduled summary listing all containers with pending updates.</div>
                                </div>
                            </label>
                            <label class="notify-option">
                                <input type="radio" name="default-notify-mode" value="muted" onchange="onNotifyModeChange(this.value)">
                                <div class="notify-option-content">
                                    <div class="notify-option-title">Silent</div>
                                    <div class="notify-option-desc">No notifications of any kind. Check the dashboard manually to see pending updates.</div>
                                </div>
                            </label>
                        </div>

                        <div id="digest-schedule-section" style="display:none">
                            <h3 class="digest-schedule-heading">Summary schedule</h3>
                            <div class="settings-rows">
                                <div class="setting-row">
                                    <div class="setting-info">
                                        <div class="setting-label">Time of day</div>
                                        <div class="setting-desc">When the summary is compiled and sent</div>
                                    </div>
                                    <input type="time" id="digest-time" class="setting-input" style="max-width:160px" value="09:00" onchange="saveDigestSettings()">
                                </div>
                                <div class="setting-row">
                                    <div class="setting-info">
                                        <div class="setting-label">Frequency</div>
                                        <div class="setting-desc">How often the summary is sent</div>
                                    </div>
                                    <select id="digest-interval" class="setting-select" onchange="saveDigestSettings()">
                                        <option value="12h">Every 12 hours</option>
                                        <option value="24h" selected>Every 24 hours</option>
                                        <option value="48h">Every 48 hours</option>
                                        <option value="168h">Weekly</option>
                                    </select>
                                </div>
                                <div class="setting-actions">
                                    <button class="btn" onclick="triggerDigest()">Send Test Summary</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </details>

                <!-- Message Templates -->
                <details class="accordion card">
                    <summary class="accordion-header">
                        <svg class="accordion-chevron" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                        <h2>Message Templates</h2>
                        <span class="accordion-preview">Customise notification message format per event type</span>
                    </summary>
                    <div class="accordion-body">
                        <p class="accordion-intro">Override the default notification message format for each event type using <a href="https://pkg.go.dev/text/template" target="_blank" rel="noopener">Go text/template</a> syntax. Leave blank to use the built-in format.</p>

                        <div class="settings-rows">
                            <div class="setting-row">
                                <div class="setting-info">
                                    <div class="setting-label">Event type</div>
                                    <div class="setting-desc">Select which event to customise</div>
                                </div>
                                <select id="template-event-type" class="setting-select" onchange="loadTemplateForEvent()">
                                    <option value="update_available">Update Available</option>
                                    <option value="update_started">Update Started</option>
                                    <option value="update_succeeded">Update Succeeded</option>
                                    <option value="update_failed">Update Failed</option>
                                    <option value="rollback_succeeded">Rollback Succeeded</option>
                                    <option value="rollback_failed">Rollback Failed</option>
                                </select>
                            </div>
                            <div class="setting-row" style="flex-direction:column; align-items:stretch">
                                <div class="setting-info" style="margin-bottom:var(--sp-2)">
                                    <div class="setting-label">Template</div>
                                    <div class="setting-desc">Available variables: <code>{{`{{.ContainerName}}`}}</code>, <code>{{`{{.OldImage}}`}}</code>, <code>{{`{{.NewImage}}`}}</code>, <code>{{`{{.OldDigest}}`}}</code>, <code>{{`{{.NewDigest}}`}}</code>, <code>{{`{{.Error}}`}}</code>, <code>{{`{{.Type}}`}}</code>, <code>{{`{{.Timestamp}}`}}</code>, <code>{{`{{.Title}}`}}</code>, <code>{{`{{.Emoji}}`}}</code>, <code>{{`{{.Severity}}`}}</code></div>
                                </div>
                                <textarea id="template-body" class="setting-input" rows="6" placeholder="Leave blank to use the default format" style="font-family:var(--font-mono); font-size:0.85rem; width:100%; resize:vertical"></textarea>
                            </div>
                        </div>

                        <div id="template-preview-output" style="display:none; margin-top:var(--sp-3)">
                            <div class="setting-label" style="margin-bottom:var(--sp-1)">Preview</div>
                            <pre id="template-preview-text" style="background:var(--bg-tertiary); padding:var(--sp-3); border-radius:var(--radius); white-space:pre-wrap; font-family:var(--font-mono); font-size:0.85rem; border:1px solid var(--border)"></pre>
                        </div>

                        <div class="setting-actions" style="margin-top:var(--sp-3)">
                            <button class="btn" onclick="previewNotifyTemplate()">Preview</button>
                            <button class="btn btn-success" onclick="saveNotifyTemplate()">Save</button>
                            <button class="btn btn-error" onclick="deleteNotifyTemplate()">Reset to Default</button>
                        </div>
                    </div>
                </details>

                <!-- Home Assistant MQTT Discovery -->
                <details class="accordion card">
                    <summary class="accordion-header">
                        <svg class="accordion-chevron" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                        <h2>Home Assistant Integration</h2>
                        <span class="accordion-preview">MQTT auto-discovery for Home Assistant</span>
                    </summary>
                    <div class="accordion-body">
                        <p class="accordion-intro">Publish MQTT auto-discovery payloads so Sentinel containers appear as entities in Home Assistant. Requires an MQTT notification channel to be configured.</p>
                        <div class="settings-rows">
                            <div class="setting-row">
                                <div class="setting-info">
                                    <div class="setting-label">Enable HA discovery</div>
                                    <div class="setting-desc">Publish update state to Home Assistant via MQTT after each scan. Uses the first enabled MQTT notification channel.</div>
                                </div>
                                <label class="toggle-switch-label">
                                    <input type="checkbox" id="ha-discovery-toggle" class="channel-toggle" onchange="setHADiscovery(this.checked)">
                                    <span id="ha-discovery-text" class="toggle-switch-text">Off</span>
                                </label>
                            </div>
                            <div class="setting-row">
                                <div class="setting-info">
                                    <div class="setting-label">Discovery prefix</div>
                                    <div class="setting-desc">MQTT topic prefix for HA auto-discovery (default: homeassistant)</div>
                                </div>
                                <div class="poll-interval-control">
                                    <input type="text" id="ha-discovery-prefix" class="setting-select" placeholder="homeassistant" style="max-width:200px">
                                    <button class="btn btn-success" onclick="saveHADiscoveryPrefix()">Save</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </details>

                <!-- Per-Container Notification Overrides -->
                <details class="accordion card">
                    <summary class="accordion-header">
                        <svg class="accordion-chevron" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                        <h2>Per-Container Overrides</h2>
                        <span class="accordion-preview">Customise notification behaviour for individual containers</span>
                    </summary>
                    <div class="accordion-body">
                        <p class="accordion-intro">Override the default notification mode for specific containers. Containers not listed here use the default mode set above.</p>
                        <div id="container-notify-prefs">
                            <p class="text-muted">Loading...</p>
                        </div>
                    </div>
                </details>

            </div>
        </div>

        <!-- Registries tab -->
        <div class="tab-panel" id="tab-registries" role="tabpanel">
            <div class="accordion-stack">
                <details class="accordion card" open>
                    <summary class="accordion-header">
                        <svg class="accordion-chevron" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                        <h2>Detected Registries</h2>
                        <span class="accordion-preview">Rate limits and authentication status</span>
                    </summary>
                    <div class="accordion-body">
                        <p class="setting-desc" style="margin-bottom:var(--sp-4)">Auto-discovered from your container images. Add credentials for higher rate limits.</p>
                        <div id="registry-status-table"></div>
                        <div id="registry-warnings" style="margin-top:var(--sp-3)"></div>
                    </div>
                </details>
                <details class="accordion card">
                    <summary class="accordion-header">
                        <svg class="accordion-chevron" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                        <h2>Manage Credentials</h2>
                        <span class="accordion-preview">Registry login credentials for authenticated pulls</span>
                    </summary>
                    <div class="accordion-body">
                        <div id="credential-list"></div>
                        <div class="setting-actions" style="margin-top:var(--sp-4)">
                            <div class="channel-add-wrap">
                                <select id="registry-type-select" class="setting-select">
                                    <option value="">Add registry credentials...</option>
                                </select>
                                <button class="btn" onclick="addRegistryCredential()">Add</button>
                            </div>
                            <button class="btn btn-success" onclick="saveRegistryCredentials(event)">Save All</button>
                        </div>
                    </div>
                </details>
                <details class="accordion card">
                    <summary class="accordion-header">
                        <svg class="accordion-chevron" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                        <h2>GHCR Alternatives</h2>
                        <span class="accordion-preview">Docker Hub images also available on GitHub Container Registry</span>
                    </summary>
                    <div class="accordion-body">
                        <p class="setting-desc" style="margin-bottom:var(--sp-4)">Sentinel checks whether your Docker Hub images are also available on GHCR, which has no rate limits.</p>
                        <div id="ghcr-alternatives-table"></div>
                    </div>
                </details>
                <details class="accordion card">
                    <summary class="accordion-header">
                        <svg class="accordion-chevron" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                        <h2>Release Note Sources</h2>
                        <span class="accordion-preview">Map container images to GitHub repos for release notes</span>
                    </summary>
                    <div class="accordion-body">
                        <p class="setting-desc" style="margin-bottom:var(--sp-4)">Custom mappings checked before built-in ones. Pattern examples: <code>nginx</code>, <code>ghcr.io/owner/*</code>, <code>myregistry.io/app</code>.</p>
                        <div id="release-sources-list"></div>
                        <div class="setting-actions" style="margin-top:var(--sp-4)">
                            <button class="btn" onclick="addReleaseSource()">Add Source</button>
                            <button class="btn btn-success" onclick="saveReleaseSources(event)">Save All</button>
                        </div>
                    </div>
                </details>
            </div>
        </div>

        <!-- Appearance tab -->
        <div class="tab-panel" id="tab-appearance" role="tabpanel">
            <div class="accordion-stack">
                <details class="accordion card">
                    <summary class="accordion-header">
                        <svg class="accordion-chevron" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                        <h2>Appearance</h2>
                        <span class="accordion-preview">Theme and layout preferences</span>
                    </summary>
                    <div class="accordion-body">
                        <div class="settings-rows">
                            <div class="setting-row">
                                <div class="setting-info">
                                    <div class="setting-label">Theme</div>
                                    <div class="setting-desc">Choose your colour scheme</div>
                                </div>
                                <select id="theme-select" class="setting-select">
                                    <option value="auto">Auto (system)</option>
                                    <option value="dark">Dark</option>
                                    <option value="light">Light</option>
                                </select>
                            </div>
                            <div class="setting-row">
                                <div class="setting-info">
                                    <div class="setting-label">Dashboard stacks</div>
                                    <div class="setting-desc">Whether container stacks start collapsed or expanded on the dashboard</div>
                                </div>
                                <select id="stack-default" class="setting-select">
                                    <option value="collapsed">Collapsed</option>
                                    <option value="expanded">Expanded</option>
                                </select>
                            </div>
                            <div class="setting-row">
                                <div class="setting-info">
                                    <div class="setting-label">Default section view</div>
                                    <div class="setting-desc">Whether page sections start collapsed or expanded (your manual changes are remembered)</div>
                                </div>
                                <select id="section-default" class="setting-select">
                                    <option value="remember">Remember my choices</option>
                                    <option value="collapsed">Always collapsed</option>
                                    <option value="expanded">Always expanded</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </details>
            </div>
        </div>

        <!-- Security tab (visible when auth off or admin) -->
        {{if .ShowSecurityTab}}
        <div class="tab-panel" id="tab-security" role="tabpanel">
            <div class="accordion-stack">

                <!-- Authentication — always live -->
                <details class="accordion card">
                    <summary class="accordion-header">
                        <svg class="accordion-chevron" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                        <h2>Authentication</h2>
                        <span class="accordion-preview">Login requirements and access control</span>
                    </summary>
                    <div class="accordion-body">
                        <div class="settings-rows">
                            <div class="setting-row">
                                <div class="setting-info">
                                    <div class="setting-label">Require login</div>
                                    <div class="setting-desc">When disabled, all endpoints are accessible without login</div>
                                </div>
                                <label class="toggle-switch-label">
                                    <input type="checkbox" id="auth-toggle" class="channel-toggle" {{if .AuthEnabled}}checked{{end}} onchange="confirmAuthToggle(this)">
                                    <span class="toggle-switch-text">{{if .AuthEnabled}}Enabled{{else}}Disabled{{end}}</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </details>

                {{if not .AuthEnabled}}
                <p class="auth-disabled-hint">Enable authentication to manage users and SSO settings.</p>
                {{end}}

                <!-- User Management -->
                <details class="accordion card{{if not .AuthEnabled}} accordion-disabled{{end}}">
                    <summary class="accordion-header">
                        <svg class="accordion-chevron" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                        <h2>User Management</h2>
                        <span class="accordion-preview">Manage users and roles</span>
                    </summary>
                    <div class="accordion-body accordion-body-flush">
                        <div class="table-wrap">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Username</th>
                                        <th>Role</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="user-list">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </details>

                <!-- Create User -->
                <details class="accordion card{{if not .AuthEnabled}} accordion-disabled{{end}}">
                    <summary class="accordion-header">
                        <svg class="accordion-chevron" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                        <h2>Create User</h2>
                        <span class="accordion-preview">Add a new user account</span>
                    </summary>
                    <div class="accordion-body">
                        <div class="settings-rows">
                            <div class="setting-row">
                                <div class="setting-info">
                                    <div class="setting-label">Username</div>
                                </div>
                                <input type="text" id="new-user-username" class="setting-select" placeholder="username" autocomplete="off">
                            </div>
                            <div class="setting-row">
                                <div class="setting-info">
                                    <div class="setting-label">Password</div>
                                    <div class="setting-desc">Min 8 characters, at least one letter and one digit</div>
                                </div>
                                <input type="password" id="new-user-password" class="setting-select" placeholder="password" autocomplete="new-password">
                            </div>
                            <div class="setting-row">
                                <div class="setting-info">
                                    <div class="setting-label">Role</div>
                                </div>
                                <select id="new-user-role" class="setting-select">
                                    <option value="viewer">viewer</option>
                                    <option value="operator">operator</option>
                                    <option value="admin">admin</option>
                                </select>
                            </div>
                            <div class="setting-row" style="justify-content:flex-end">
                                <button class="btn btn-success" onclick="createUser()">Create User</button>
                            </div>
                        </div>
                    </div>
                </details>

                <!-- OIDC / SSO -->
                <details class="accordion card{{if not .AuthEnabled}} accordion-disabled{{end}}">
                    <summary class="accordion-header">
                        <svg class="accordion-chevron" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                        <h2>Single Sign-On (OIDC)</h2>
                        <span class="accordion-preview">OpenID Connect identity provider integration</span>
                    </summary>
                    <div class="accordion-body">
                        <p style="font-size:0.875rem;color:var(--fg-secondary);margin:0 0 var(--sp-4) 0">
                            Connect an external Identity Provider (Authelia, Authentik, Keycloak, etc.) for single sign-on.
                            Password login always remains available as fallback.
                        </p>
                        <div class="settings-rows">
                            <div class="setting-row">
                                <div class="setting-info">
                                    <div class="setting-label">Enable OIDC</div>
                                    <div class="setting-desc">Show the "Sign in with SSO" button on the login page</div>
                                </div>
                                <label class="toggle-switch-label">
                                    <input type="checkbox" id="oidc-enabled" class="channel-toggle" onchange="updateToggleText('oidc-enabled-text', this.checked)">
                                    <span id="oidc-enabled-text" class="toggle-switch-text">Off</span>
                                </label>
                            </div>
                            <div class="setting-row">
                                <div class="setting-info">
                                    <div class="setting-label">Issuer URL</div>
                                    <div class="setting-desc">OpenID Connect discovery endpoint, e.g. https://auth.example.com</div>
                                </div>
                                <input type="text" id="oidc-issuer-url" class="setting-input" placeholder="https://auth.example.com">
                            </div>
                            <div class="setting-row">
                                <div class="setting-info">
                                    <div class="setting-label">Client ID</div>
                                    <div class="setting-desc">OAuth2 client ID registered with your Identity Provider</div>
                                </div>
                                <input type="text" id="oidc-client-id" class="setting-input" placeholder="sentinel">
                            </div>
                            <div class="setting-row">
                                <div class="setting-info">
                                    <div class="setting-label">Client Secret</div>
                                    <div class="setting-desc">OAuth2 client secret (stored encrypted in the database)</div>
                                </div>
                                <input type="password" id="oidc-client-secret" class="setting-input" placeholder="secret">
                            </div>
                            <div class="setting-row">
                                <div class="setting-info">
                                    <div class="setting-label">Redirect URL</div>
                                    <div class="setting-desc">Callback URL registered with your IdP. Auto-detected if left empty.</div>
                                </div>
                                <input type="text" id="oidc-redirect-url" class="setting-input" placeholder="https://sentinel.example.com/api/auth/oidc/callback">
                            </div>
                            <div class="setting-row">
                                <div class="setting-info">
                                    <div class="setting-label">Auto-create users</div>
                                    <div class="setting-desc">Automatically create local accounts for users who sign in via OIDC for the first time</div>
                                </div>
                                <label class="toggle-switch-label">
                                    <input type="checkbox" id="oidc-auto-create" class="channel-toggle" onchange="updateToggleText('oidc-auto-create-text', this.checked)">
                                    <span id="oidc-auto-create-text" class="toggle-switch-text">Off</span>
                                </label>
                            </div>
                            <div class="setting-row">
                                <div class="setting-info">
                                    <div class="setting-label">Default role for new users</div>
                                    <div class="setting-desc">Role assigned to auto-created OIDC users</div>
                                </div>
                                <select id="oidc-default-role" class="setting-select">
                                    <option value="viewer">viewer</option>
                                    <option value="operator">operator</option>
                                    <option value="admin">admin</option>
                                </select>
                            </div>
                            <div class="setting-row" style="justify-content:flex-end;gap:var(--sp-2)">
                                <button class="btn btn-success" onclick="saveOIDCSettings()">Save</button>
                            </div>
                        </div>
                    </div>
                </details>

            </div>
        </div>
        {{end}}

        <!-- Cluster tab -->
        <div class="tab-panel" id="tab-cluster" role="tabpanel">
            <div class="card">
                <div class="card-header">
                    <h2>Multi-Host Monitoring</h2>
                </div>
                <div class="card-body" style="padding: var(--sp-4) var(--sp-5)">
                    <p class="accordion-intro">Monitor containers across multiple Docker hosts using lightweight agents that report back over encrypted gRPC (mTLS).</p>
                    <div class="settings-rows">
                        <div class="setting-row">
                            <div class="setting-info">
                                <div class="setting-label">Enable cluster mode</div>
                                <div class="setting-desc">Starts a gRPC server for agent connections. No container restart needed.</div>
                            </div>
                            <label class="toggle-switch-label">
                                <input type="checkbox" id="cluster-enabled" class="channel-toggle" onchange="onClusterToggle(this.checked)">
                                <span id="cluster-enabled-text" class="toggle-switch-text">Off</span>
                            </label>
                        </div>
                    </div>

                    <div id="cluster-fields" class="cluster-fields disabled">
                        <div class="settings-rows">
                            <div class="setting-row">
                                <div class="setting-info">
                                    <div class="setting-label">gRPC port</div>
                                    <div class="setting-desc">Port for agent connections. Change requires restart.</div>
                                </div>
                                <input type="number" id="cluster-port" class="setting-input" style="max-width:120px" value="9443" min="1024" max="65535" onchange="saveClusterSettings()">
                            </div>
                            <div class="setting-row">
                                <div class="setting-info">
                                    <div class="setting-label">Grace period</div>
                                    <div class="setting-desc">How long agents wait before entering autonomous mode when this server is unreachable.</div>
                                </div>
                                <select id="cluster-grace" class="setting-select" onchange="saveClusterSettings()">
                                    <option value="5m">5 minutes</option>
                                    <option value="15m">15 minutes</option>
                                    <option value="30m" selected>30 minutes</option>
                                    <option value="1h">1 hour</option>
                                    <option value="2h">2 hours</option>
                                </select>
                            </div>
                            <div class="setting-row">
                                <div class="setting-info">
                                    <div class="setting-label">Default remote policy</div>
                                    <div class="setting-desc">Update policy applied to containers discovered on newly enrolled hosts.</div>
                                </div>
                                <select id="cluster-policy" class="setting-select" onchange="saveClusterSettings()">
                                    <option value="manual" selected>manual</option>
                                    <option value="auto">auto</option>
                                    <option value="pinned">pinned</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Portainer tab -->
        <div class="tab-panel" id="tab-portainer" role="tabpanel">
            <div class="card">
                <div class="card-header">
                    <h2>Portainer Integration</h2>
                </div>
                <div class="card-body" style="padding: var(--sp-4) var(--sp-5)">
                    <p class="accordion-intro">Connect to a Portainer instance to view endpoints and containers from the Portainer dashboard.</p>
                    <div class="settings-rows">
                        <div class="setting-row">
                            <div class="setting-info">
                                <div class="setting-label">Enable Portainer</div>
                                <div class="setting-desc">Show the Portainer dashboard and scan Portainer-managed containers. Requires a restart after changing URL or token.</div>
                            </div>
                            <label class="toggle-switch-label">
                                <input type="checkbox" id="portainer-enabled" class="channel-toggle" onchange="onPortainerToggle(this.checked)">
                                <span id="portainer-enabled-text" class="toggle-switch-text">Off</span>
                            </label>
                        </div>
                    </div>
                    <div id="portainer-fields" class="cluster-fields disabled">
                    <div class="settings-rows">
                        <div class="setting-row">
                            <div class="setting-info">
                                <div class="setting-label">Portainer URL</div>
                                <div class="setting-desc">Base URL of your Portainer instance, e.g. https://portainer.example.com</div>
                            </div>
                            <input type="text" id="portainer-url" class="setting-input" placeholder="https://portainer.example.com" onchange="savePortainerURL()">
                        </div>
                        <div class="setting-row">
                            <div class="setting-info">
                                <div class="setting-label">API Token</div>
                                <div class="setting-desc">Portainer API access token (Settings &#8250; Users &#8250; Access tokens).</div>
                            </div>
                            <input type="password" id="portainer-token" class="setting-input" placeholder="ptr_..." onchange="savePortainerToken()">
                        </div>
                        <div class="setting-row">
                            <div class="setting-info">
                                <div class="setting-label">Connection</div>
                                <div class="setting-desc">Test connectivity with the current URL and token.</div>
                            </div>
                            <button class="btn btn-info" id="portainer-test-btn" onclick="testPortainerConnection()">Test Connection</button>
                        </div>
                    </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- About tab -->
        <div class="tab-panel" id="tab-about" role="tabpanel">
            <div class="card">
                <div class="card-body" style="padding: var(--sp-4) var(--sp-5)">
                    <div id="about-content">
                        <p class="text-muted">Loading...</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="toast-container" class="toast-container"></div>
    <script src="/static/app.js"></script>
    <script src="/static/auth.js"></script>
    <script>
// General settings
function saveGeneralSetting(key, value) {
    fetch('/api/settings/general', {
        method: 'POST',
        headers: {'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken},
        body: JSON.stringify({key: key, value: value})
    })
    .then(function(r) { return r.json(); })
    .then(function(d) {
        if (d.error) { showToast(d.error, 'error'); return; }
        showToast('Setting saved');
        document.getElementById('general-restart-banner').style.display = 'block';
    })
    .catch(function() { showToast('Failed to save', 'error'); });
}

function switchRole() {
    var current = document.getElementById('general-role-label').textContent.trim();
    var target = (current === 'server') ? 'agent' : 'server';
    if (!confirm('Switch this instance to ' + target + ' mode? This will take effect after a container restart.')) return;
    fetch('/api/settings/switch-role', {
        method: 'POST',
        headers: {'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken},
        body: JSON.stringify({role: target})
    })
    .then(function(r) { return r.json(); })
    .then(function(d) {
        if (d.error) { showToast(d.error, 'error'); return; }
        showToast('Role saved — restart to apply');
        document.getElementById('general-role-label').textContent = target;
        var opposite = (target === 'server') ? 'Agent' : 'Server';
        document.getElementById('general-switch-role-btn').textContent = 'Switch to ' + opposite;
        document.getElementById('general-restart-banner').style.display = 'block';
    })
    .catch(function() { showToast('Failed to save', 'error'); });
}

function onPortainerToggle(enabled) {
    updateToggleText('portainer-enabled-text', enabled);
    togglePortainerFields(enabled);
    fetch('/api/settings/portainer-enabled', {
        method: 'POST',
        headers: {'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken},
        body: JSON.stringify({enabled: enabled})
    })
    .then(function(r) { return r.json(); })
    .then(function(d) {
        if (d.error) { showToast(d.error, 'error'); return; }
        showToast('Portainer ' + (enabled ? 'enabled' : 'disabled') + ' — restart to apply');
    })
    .catch(function() { showToast('Failed to save', 'error'); });
}

function togglePortainerFields(enabled) {
    var fields = document.getElementById('portainer-fields');
    if (!fields) return;
    if (enabled) {
        fields.classList.remove('disabled');
    } else {
        fields.classList.add('disabled');
    }
}

function savePortainerURL() {
    var url = (document.getElementById('portainer-url') || {}).value || '';
    fetch('/api/settings/portainer-url', {
        method: 'POST',
        headers: {'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken},
        body: JSON.stringify({url: url})
    })
    .then(function(r) { return r.json(); })
    .then(function(d) {
        if (d.error) { showToast(d.error, 'error'); return; }
        showToast('Portainer URL saved');
    })
    .catch(function() { showToast('Failed to save', 'error'); });
}

function savePortainerToken() {
    var token = (document.getElementById('portainer-token') || {}).value || '';
    fetch('/api/settings/portainer-token', {
        method: 'POST',
        headers: {'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken},
        body: JSON.stringify({token: token})
    })
    .then(function(r) { return r.json(); })
    .then(function(d) {
        if (d.error) { showToast(d.error, 'error'); return; }
        showToast('Portainer token saved');
    })
    .catch(function() { showToast('Failed to save', 'error'); });
}

function testPortainerConnection() {
    var btn = document.getElementById('portainer-test-btn');
    if (btn) btn.disabled = true;
    fetch('/api/settings/portainer-test', {
        method: 'POST',
        headers: {'X-CSRF-Token': csrfToken}
    })
    .then(function(r) { return r.json(); })
    .then(function(d) {
        if (d.error) { showToast('Connection failed: ' + d.error, 'error'); }
        else { showToast('Connection successful'); }
    })
    .catch(function() { showToast('Connection failed', 'error'); })
    .finally(function() { if (btn) btn.disabled = false; });
}

// Load current values
(function() {
    fetch('/api/settings')
        .then(function(r) { return r.json(); })
        .then(function(d) {
            var port = document.getElementById('general-web-port');
            if (port) port.value = d['SENTINEL_WEB_PORT'] || d['web_port'] || '8080';

            var tls = document.getElementById('general-tls-mode');
            if (tls) {
                var mode = d['tls_mode'] || 'off';
                if (!d['tls_mode']) {
                    if (d['SENTINEL_TLS_AUTO'] === 'true') mode = 'auto';
                    else if (d['SENTINEL_TLS_CERT'] && d['SENTINEL_TLS_CERT'] !== '') mode = 'manual';
                }
                tls.value = mode;
            }

            var log = document.getElementById('general-log-format');
            if (log) {
                var fmt = d['log_format'] || (d['SENTINEL_LOG_JSON'] === 'true' ? 'json' : 'text');
                log.value = fmt;
            }

            var role = document.getElementById('general-role-label');
            var roleBtn = document.getElementById('general-switch-role-btn');
            var currentRole = d['instance_role'] || 'server';
            if (role) role.textContent = currentRole;
            if (roleBtn) {
                roleBtn.textContent = currentRole === 'agent' ? 'Switch to Server' : 'Switch to Agent';
            }
            // Docker TLS cert paths.
            var tlsCaEl = document.getElementById('docker-tls-ca');
            var tlsCertEl = document.getElementById('docker-tls-cert');
            var tlsKeyEl = document.getElementById('docker-tls-key');
            if (tlsCaEl) tlsCaEl.value = d['docker_tls_ca'] || '';
            if (tlsCertEl) tlsCertEl.value = d['docker_tls_cert'] || '';
            if (tlsKeyEl) tlsKeyEl.value = d['docker_tls_key'] || '';

            var pUrl = document.getElementById('portainer-url');
            if (pUrl && d['SENTINEL_PORTAINER_URL']) pUrl.value = d['SENTINEL_PORTAINER_URL'];
            if (pUrl && d['portainer_url']) pUrl.value = d['portainer_url'];

            var pEnabled = d['portainer_enabled'] === 'true';
            var pToggle = document.getElementById('portainer-enabled');
            if (pToggle) {
                pToggle.checked = pEnabled;
                updateToggleText('portainer-enabled-text', pEnabled);
                togglePortainerFields(pEnabled);
            }
        });
})();
    </script>
</body>
</html>
{{end}}
