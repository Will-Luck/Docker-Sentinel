{{define "account.html"}}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Account — Docker-Sentinel</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png">
    <link rel="apple-touch-icon" href="/static/apple-touch-icon.png">
</head>
<body>
    <a href="#main-content" class="skip-link">Skip to main content</a>
    <nav class="nav">
        <a href="/" class="nav-brand">
            <img src="/favicon.svg" alt="S" class="nav-logo">
            <span class="nav-brand-text">Sentinel</span>
        </a>
        <div class="nav-links">
            <a href="/" class="nav-link">Dashboard</a>
            <a href="/queue" class="nav-link">
                Pending Updates
                {{if .QueueCount}}<span class="nav-badge">{{.QueueCount}}</span>{{end}}
            </a>
            <a href="/history" class="nav-link">History</a>
            <a href="/logs" class="nav-link">Logs</a>
            <a href="/images" class="nav-link">Images</a>
            <a href="/settings" class="nav-link">Settings</a>
            {{if .ClusterEnabled}}<a href="/cluster" class="nav-link">Cluster</a>{{end}}
            {{if .PortainerEnabled}}<a href="/portainer" class="nav-link">Portainer</a>{{end}}
        </div>
        <div class="nav-status" aria-live="polite">
            <span id="sse-indicator" class="status-dot disconnected"></span>
            <span id="sse-label" class="nav-status-text">Disconnected</span>
        </div>
        {{if .AuthEnabled}}{{if .CurrentUser}}
        <div class="nav-user">
            <button class="nav-user-btn" onclick="toggleUserDropdown(event)" aria-haspopup="true" aria-expanded="false">
                <span>{{.CurrentUser.Username}}</span>
                <span class="nav-user-role">{{.CurrentUser.RoleID}}</span>
                <span class="nav-user-chevron">&#9662;</span>
            </button>
            <div class="nav-user-dropdown" id="user-dropdown">
                <a href="/account">My Account</a>
                <div class="dropdown-divider"></div>
                <form method="POST" action="/logout" style="margin:0">
                    <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
                    <button type="submit">Logout</button>
                </form>
            </div>
        </div>
        {{end}}{{else}}
        <a href="/settings" class="nav-auth-off" onclick="localStorage.setItem('sentinel-settings-tab','security')">Auth: Off</a>
        {{end}}
    </nav>

    <main class="main-content" id="main-content">
        <div class="page-header">
            <div>
                <h1>My Account</h1>
                <p class="subtitle">Manage your sessions and API tokens</p>
            </div>
        </div>

        <!-- Change Password -->
        <div class="card" style="margin-bottom:var(--sp-4)">
            <div class="card-header"><h2>Change Password</h2></div>
            <div class="card-body">
                <form id="change-password-form" class="settings-grid" style="max-width:400px">
                    <input type="hidden" autocomplete="username" value="{{.CurrentUser.Username}}">
                    <div style="margin-bottom:var(--sp-3)">
                        <label style="display:block;font-size:0.875rem;font-weight:500;color:var(--fg-secondary);margin-bottom:var(--sp-1)" for="current-password">Current Password</label>
                        <input class="setting-input" type="password" id="current-password" autocomplete="current-password" required style="width:100%">
                    </div>
                    <div style="margin-bottom:var(--sp-3)">
                        <label style="display:block;font-size:0.875rem;font-weight:500;color:var(--fg-secondary);margin-bottom:var(--sp-1)" for="new-password">New Password</label>
                        <input class="setting-input" type="password" id="new-password" autocomplete="new-password" required minlength="8" style="width:100%">
                    </div>
                    <button class="btn btn-success" type="submit">Update Password</button>
                </form>
            </div>
        </div>

        <!-- Two-Factor Authentication -->
        <div class="card" style="margin-bottom:var(--sp-4)" id="totp-section">
            <div class="card-header"><h2>Two-Factor Authentication</h2></div>
            <div class="card-body">
                <!-- Shown when 2FA is enabled -->
                <div id="totp-enabled-content" style="display:none">
                    <p style="font-size:0.875rem;color:var(--fg-secondary);margin:0 0 var(--sp-3) 0">
                        <span class="badge badge-success" style="margin-right:var(--sp-2)">Enabled</span>
                        Two-factor authentication is active on your account.
                    </p>
                    <p style="font-size:0.85rem;color:var(--fg-secondary);margin:0 0 var(--sp-3) 0">
                        Recovery codes: <strong id="totp-codes-left">--</strong>
                    </p>
                    <div style="display:flex;gap:var(--sp-2);align-items:center;flex-wrap:wrap">
                        <input type="password" id="totp-disable-password" placeholder="Current password" class="setting-input" style="max-width:200px" autocomplete="current-password">
                        <button class="btn btn-error" onclick="disableTOTP()">Disable 2FA</button>
                    </div>
                </div>

                <!-- Shown when 2FA is disabled -->
                <div id="totp-disabled-content">
                    <p style="font-size:0.875rem;color:var(--fg-secondary);margin:0 0 var(--sp-3) 0">Add an extra layer of security by requiring a code from an authenticator app when signing in.</p>
                    <button class="btn btn-success" id="totp-setup-btn" onclick="startTOTPSetup()">Enable 2FA</button>
                </div>

                <!-- Setup flow (hidden until Enable is clicked) -->
                <div id="totp-setup-flow" style="display:none;margin-top:var(--sp-3);padding:var(--sp-3);background:var(--md-surface-container);border:1px solid var(--border);border-radius:var(--radius)">
                    <p style="font-size:0.875rem;font-weight:500;margin:0 0 var(--sp-2) 0">1. Scan this QR code with your authenticator app</p>
                    <div id="totp-qr" style="margin:var(--sp-2) 0;display:flex;justify-content:center"></div>
                    <p style="font-size:0.8rem;color:var(--fg-secondary);margin:var(--sp-2) 0">Or enter this secret manually:</p>
                    <code id="totp-secret-display" style="display:block;padding:var(--sp-2) var(--sp-3);background:var(--md-surface);border:1px solid var(--border);border-radius:var(--radius);font-size:0.85rem;word-break:break-all;user-select:all;margin-bottom:var(--sp-3)"></code>

                    <p style="font-size:0.875rem;font-weight:500;margin:0 0 var(--sp-2) 0">2. Enter the 6-digit code to verify</p>
                    <div style="display:flex;gap:var(--sp-2);align-items:center">
                        <input type="text" id="totp-confirm-code" class="setting-input" placeholder="000000" autocomplete="one-time-code" maxlength="6" inputmode="numeric" style="max-width:120px">
                        <button class="btn btn-success" onclick="confirmTOTPSetup()">Verify &amp; Enable</button>
                    </div>
                </div>

                <!-- Recovery codes display (shown once after confirming) -->
                <div id="totp-recovery-display" style="display:none;margin-top:var(--sp-3);padding:var(--sp-3);background:var(--warning-bg);border:1px solid var(--warning);border-radius:var(--radius)">
                    <p style="font-weight:500;margin:0 0 var(--sp-2) 0">Save your recovery codes</p>
                    <p style="font-size:0.85rem;color:var(--fg-secondary);margin:0 0 var(--sp-2) 0">Each code can only be used once. Store them in a safe place — you will not see them again.</p>
                    <pre id="totp-recovery-codes" style="padding:var(--sp-2) var(--sp-3);background:var(--md-surface);border:1px solid var(--border);border-radius:var(--radius);font-size:0.9rem;font-family:var(--font-mono);white-space:pre-wrap;user-select:all;margin:0 0 var(--sp-2) 0"></pre>
                    <button class="btn" onclick="copyRecoveryCodes()">Copy Codes</button>
                </div>
            </div>
        </div>

        {{if .WebAuthnEnabled}}
        <!-- Passkeys -->
        <div id="passkey-section">
        <div class="card" style="margin-bottom:var(--sp-4)" id="passkeys">
            <div class="card-header"><h2>Passkeys</h2></div>
            <div class="card-body">
                <p style="font-size:0.875rem;color:var(--fg-secondary);margin:0 0 var(--sp-3) 0">Use passkeys for fast, phishing-resistant sign-in with your fingerprint, face, or screen lock.</p>
                <div class="table-wrap">
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Created</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="passkey-list">
                            <tr><td colspan="3" style="text-align:center;color:var(--fg-secondary)">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
                <div style="margin-top:var(--sp-3);display:flex;gap:var(--sp-2);align-items:center">
                    <input type="text" id="passkey-name" placeholder="Passkey name (optional)" class="setting-input" style="max-width:200px">
                    <button class="btn btn-success" id="register-passkey-btn" onclick="registerPasskey()">Register Passkey</button>
                </div>
            </div>
        </div>
        </div>
        {{end}}

        <!-- Active Sessions -->
        <div class="card" style="margin-bottom:var(--sp-4)">
            <div class="card-header"><h2>Active Sessions</h2></div>
            <div class="card-body">
                <div class="table-wrap">
                    <table>
                        <thead>
                            <tr>
                                <th>IP</th>
                                <th>User Agent</th>
                                <th>Created</th>
                                <th>Expires</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="session-list">
                            {{range .Sessions}}
                            <tr>
                                <td class="mono">{{.IP}}</td>
                                <td style="max-width:300px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="{{.UserAgent}}">{{.UserAgent}}</td>
                                <td>{{fmtTimeAgo .CreatedAt}}</td>
                                <td title="{{fmtTime .ExpiresAt}}">{{fmtTimeUntil .ExpiresAt}}</td>
                                <td><button class="btn btn-error" onclick="revokeSession('{{.Token}}')">Revoke</button></td>
                            </tr>
                            {{else}}
                            <tr><td colspan="5" style="text-align:center;color:var(--fg-secondary)">No active sessions</td></tr>
                            {{end}}
                        </tbody>
                    </table>
                </div>
                <div style="margin-top:var(--sp-3)">
                    <button class="btn btn-error" onclick="revokeAllSessions()">Revoke All Other Sessions</button>
                </div>
            </div>
        </div>

        <!-- API Tokens -->
        <div class="card">
            <div class="card-header"><h2>API Tokens</h2></div>
            <div class="card-body">
                <div class="table-wrap">
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Created</th>
                                <th>Last Used</th>
                                <th>Expires</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="token-list">
                            {{range .APITokens}}
                            <tr>
                                <td>{{.Name}}</td>
                                <td>{{fmtTimeAgo .CreatedAt}}</td>
                                <td>{{if .LastUsedAt.IsZero}}Never{{else}}{{fmtTimeAgo .LastUsedAt}}{{end}}</td>
                                <td>{{if .ExpiresAt.IsZero}}Never{{else}}{{fmtTimeUntil .ExpiresAt}}{{end}}</td>
                                <td><button class="btn btn-error" onclick="deleteToken('{{.ID}}')">Delete</button></td>
                            </tr>
                            {{else}}
                            <tr><td colspan="5" style="text-align:center;color:var(--fg-secondary)">No API tokens</td></tr>
                            {{end}}
                        </tbody>
                    </table>
                </div>
                <div style="margin-top:var(--sp-3);display:flex;gap:var(--sp-2);align-items:center">
                    <input type="text" id="new-token-name" placeholder="Token name" class="setting-input" style="max-width:200px">
                    <button class="btn btn-success" onclick="createToken()">Create Token</button>
                </div>
                <div id="new-token-display" style="display:none;margin-top:var(--sp-3);padding:var(--sp-3);background:var(--warning-bg);border:1px solid var(--warning);border-radius:var(--radius)">
                    <strong>Copy this token now — it will not be shown again:</strong>
                    <div style="margin-top:var(--sp-2);display:flex;align-items:center;gap:var(--sp-2)">
                        <code id="new-token-value" style="flex:1;padding:var(--sp-2) var(--sp-3);background:var(--md-surface-container);border:1px solid var(--border);border-radius:var(--radius);word-break:break-all;font-size:0.85rem"></code>
                        <button class="btn" onclick="copyToken()" title="Copy to clipboard" style="flex-shrink:0">Copy</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="toast-container" class="toast-container"></div>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script src="/static/app.js"></script>
    <script src="/static/auth.js"></script>
    <script src="/static/webauthn.js"></script>
</body>
</html>
{{end}}
